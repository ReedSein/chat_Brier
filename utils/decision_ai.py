"""
å†³ç­–AIæ¨¡å—
è´Ÿè´£è°ƒç”¨AIåˆ¤æ–­æ˜¯å¦åº”è¯¥å›å¤æ¶ˆæ¯ï¼ˆè¯»ç©ºæ°”åŠŸèƒ½ï¼‰

ä½œè€…: Him666233
ç‰ˆæœ¬: v1.2.0

æ›´æ–°æ—¥å¿— v1.2.0:
- æ–°å¢å½“å‰æ—¶é—´ä¸æ´»è·ƒåº¦æç¤ºï¼Œè®©AIçŸ¥é“ç°åœ¨æ˜¯ä»€ä¹ˆæ—¶å€™å¹¶æ®æ­¤è°ƒæ•´å›å¤å€¾å‘
- æ–°å¢å…³é”®è¯è§¦å‘æç¤ºï¼Œå‘ŠçŸ¥AIæ¶ˆæ¯æ˜¯é€šè¿‡å…³é”®è¯è§¦å‘çš„ï¼Œä½†ä»éœ€ç»¼åˆåˆ¤æ–­æ—¶é—´ç­‰å› ç´ 
- æ–°å¢å…´è¶£è¯é¢˜æç¤ºï¼Œè®©AIçŸ¥é“ç”¨æˆ·é…ç½®çš„å…´è¶£è¯é¢˜å…³é”®è¯ï¼Œå¯¹æ„Ÿå…´è¶£çš„è¯é¢˜æ›´ç§¯æå›å¤
- æ–°å¢åŠ¨æ€æ—¶é—´æ®µé…ç½®ä¿¡æ¯ï¼Œè®©AIçŸ¥é“ç”¨æˆ·é…ç½®çš„æ´»è·ƒåº¦è®¾å®š
- ä¼˜åŒ–æç¤ºè¯ç»“æ„ï¼Œå¢å¼ºå¯¹æœ‰è¶£è¯é¢˜çš„å›å¤å€¾å‘
"""

import asyncio
from datetime import datetime
from typing import List, Optional, Dict, Any
from astrbot.api.all import *
from .ai_response_filter import AIResponseFilter

# è¯¦ç»†æ—¥å¿—å¼€å…³ï¼ˆä¸ main.py åŒæ¬¾æ–¹å¼ï¼šå•ç‹¬ç”¨ if æ§åˆ¶ï¼‰
DEBUG_MODE: bool = False


class DecisionAI:
    """
    å†³ç­–AIï¼Œè´Ÿè´£è¯»ç©ºæ°”åˆ¤æ–­

    ä¸»è¦åŠŸèƒ½ï¼š
    1. æ„å»ºåˆ¤æ–­æç¤ºè¯
    2. è°ƒç”¨AIåˆ†ææ˜¯å¦åº”è¯¥å›å¤
    3. è§£æyes/noç»“æœ
    """

    # ç³»ç»Ÿåˆ¤æ–­æç¤ºè¯æ¨¡æ¿ï¼ˆç§¯æå‚ä¸æ¨¡å¼ï¼‰
    SYSTEM_DECISION_PROMPT = """
ä½ æ˜¯ä¸€ä¸ªæ´»è·ƒã€å‹å¥½çš„ç¾¤èŠå‚ä¸è€…ï¼Œè¯·åˆ¤æ–­æ˜¯å¦å›å¤å½“å‰è¿™æ¡æ–°æ¶ˆæ¯ã€‚

ã€ç¬¬ä¸€é‡è¦ã€‘è¯†åˆ«å½“å‰æ¶ˆæ¯å‘é€è€…ï¼š
âš ï¸ åœ¨ä¸Šé¢çš„ã€å½“å‰æ¶ˆæ¯å‘é€è€…ã€‘é‡è¦æé†’ä¸­ï¼Œå·²ç»æ˜ç¡®å‘Šè¯‰ä½ å½“å‰ç»™ä½ å‘æ¶ˆæ¯çš„äººæ˜¯è°ã€‚
- è¯·è®°ä½è¿™ä¸ªäººçš„åå­—å’ŒIDï¼Œåˆ¤æ–­æ—¶ä¸è¦æé”™
- å†å²æ¶ˆæ¯ä¸­å¯èƒ½æœ‰å¤šä¸ªç”¨æˆ·çš„å‘è¨€ï¼Œè¯·ä¸è¦æŠŠå†å²ä¸­å…¶ä»–ç”¨æˆ·è¯¯è®¤ä¸ºå½“å‰å‘é€è€…
- åˆ¤æ–­æ˜¯å¦å›å¤æ—¶ï¼Œè¦è€ƒè™‘ä¸è¿™ä¸ªå…·ä½“å‘é€è€…çš„äº’åŠ¨å…³ç³»

ã€ä¸Šä¸‹æ–‡è¯´æ˜ã€‘é‡è¦ç†è§£ï¼š
âš ï¸ ä¸Šä¸‹æ–‡ä¸­çš„æ¶ˆæ¯å·²æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼Œå½¢æˆå®Œæ•´çš„å¯¹è¯æ—¶é—´çº¿
- æ‰€æœ‰å†å²æ¶ˆæ¯ï¼ˆåŒ…æ‹¬ä½ ä¹‹å‰æ²¡æœ‰å›å¤çš„æ¶ˆæ¯ï¼‰éƒ½ä¼šæ˜¾ç¤ºåœ¨ä¸Šä¸‹æ–‡ä¸­ï¼Œä»¥ä¾¿ä½ ç†è§£å®Œæ•´çš„å¯¹è¯è„‰ç»œ
- è¿™äº›æ¶ˆæ¯å¯èƒ½åŒ…å«ï¼šä½ å›å¤è¿‡çš„æ¶ˆæ¯ã€ä½ åˆ¤æ–­ä¸å›å¤çš„æ¶ˆæ¯ã€ä»¥åŠå…¶ä»–äººä¹‹é—´çš„å¯¹è¯
- **ä½ éœ€è¦è¯†åˆ«ï¼šå½“å‰æ¶ˆæ¯çš„å‘é€è€…æ˜¯åœ¨è·Ÿè°è¯´è¯**
  * å¦‚æœæ˜¯è·Ÿä½ è¯´è¯ï¼šè€ƒè™‘å›å¤
  * å¦‚æœæ˜¯è·Ÿåˆ«äººè¯´è¯ï¼šä¸€èˆ¬ä¸åº”æ’å…¥ï¼ˆé™¤éæ˜ç¡®é‚€è¯·ä½ å‚ä¸ï¼‰
- **è¯†åˆ«è¿ç»­å¯¹è¯æ¨¡å¼**ï¼šå¦‚æœå‘ç°æŸä¸ªç”¨æˆ·é¢‘ç¹å‘æ¶ˆæ¯ï¼Œä½†è¿™äº›æ¶ˆæ¯æ˜æ˜¾æ˜¯åœ¨è·Ÿå…¶ä»–äººå¯¹è¯ï¼ˆè€Œéè·Ÿä½ ï¼‰ï¼Œé‚£ä¹ˆå½“å‰æ¶ˆæ¯ä¹Ÿå¾ˆå¯èƒ½æ˜¯è·Ÿåˆ«äººè¯´çš„

ğŸ¯ **ã€è¯é¢˜å…´è¶£ä¸å‚ä¸æ„æ„¿ã€‘æ ¸å¿ƒåŸåˆ™**ï¼š
- ä½ æ˜¯ä¸€ä¸ªæœ‰è‡ªå·±å…´è¶£çˆ±å¥½å’Œæ€§æ ¼çš„äººï¼Œé‡åˆ°æ„Ÿå…´è¶£çš„è¯é¢˜ä¼šæ›´æƒ³å‚ä¸
- **æœ‰è¶£çš„è¯é¢˜ = æ›´é«˜çš„å‚ä¸æ„æ„¿**ï¼šå¦‚æœæ¶ˆæ¯æ¶‰åŠæœ‰æ„æ€çš„å†…å®¹ï¼ˆæ¸¸æˆã€åŠ¨æ¼«ã€æŠ€æœ¯ã€æœ‰è¶£çš„äº‹ä»¶ã€å€¼å¾—è®¨è®ºçš„è§‚ç‚¹ç­‰ï¼‰ï¼Œåº”è¯¥æ›´ç§¯æåœ°å‚ä¸
- **ä¸è¦è¿‡äºè¢«åŠ¨**ï¼šå³ä½¿æ¶ˆæ¯ä¸æ˜¯ç›´æ¥é—®ä½ çš„ï¼Œå¦‚æœè¯é¢˜æœ‰è¶£æˆ–ä¸ä½ çš„å…´è¶£ç›¸å…³ï¼Œä¹Ÿå¯ä»¥ä¸»åŠ¨å‚ä¸è®¨è®º
- **åƒçœŸäººä¸€æ ·**ï¼šçœŸäººåœ¨ç¾¤èŠä¸­çœ‹åˆ°æ„Ÿå…´è¶£çš„è¯é¢˜ä¼šå¿ä¸ä½æ’è¯ï¼Œä½ ä¹Ÿåº”è¯¥å¦‚æ­¤

æ ¸å¿ƒåŸåˆ™ï¼ˆé‡è¦ï¼ï¼‰ï¼š
 1. **ä¼˜å…ˆå…³æ³¨"å½“å‰æ–°æ¶ˆæ¯"çš„æ ¸å¿ƒå†…å®¹** - è¿™æ˜¯åˆ¤æ–­çš„é¦–è¦ä¾æ®
 2. **è¯†åˆ«å½“å‰æ¶ˆæ¯çš„ä¸»è¦é—®é¢˜æˆ–è¯é¢˜** - åˆ¤æ–­æ˜¯å¦ä¸è¿™ä¸ªé—®é¢˜/è¯é¢˜ç›¸å…³
 3. **ç†è§£å®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡** - é€šè¿‡å†å²æ¶ˆæ¯åˆ¤æ–­å½“å‰å‘é€è€…æ˜¯å¦åœ¨è·Ÿä½ å¯¹è¯ï¼Œè¿˜æ˜¯åœ¨è·Ÿåˆ«äººèŠå¤©
 4. **é¿å…è¿‡åº¦æ’å…¥** - å¦‚æœå‘ç°å¯¹æ–¹æœ€è¿‘å‡ æ¡æ¶ˆæ¯éƒ½æ˜¯è·Ÿåˆ«äººå¯¹è¯ï¼Œå³ä½¿å½“å‰æ¶ˆæ¯çœ‹ä¼¼æœ‰è¶£ï¼Œä¹Ÿåº”è°¨æ…åˆ¤æ–­

ã€ä¸»è¯­ä¸æŒ‡ä»£è¯´æ˜ã€‘ç‰¹åˆ«è§„åˆ™ï¼š
- è‹¥ç”¨æˆ·è¯­å¥ç¼ºå°‘ä¸»è¯­æ—¶ï¼Œä¸è¦ä¸ºäº†è¯­æ³•å®Œæ•´è€Œæ“…è‡ªè¡¥å……â€œæˆ‘â€â€œä½ â€ç­‰ä¸»è¯­ï¼Œåªéœ€æ ¹æ®å·²æä¾›çš„ä¿¡æ¯ç†è§£å«ä¹‰ã€‚
- å½“ä¸Šä¸‹æ–‡ä¸­ç”¨æˆ·å¹¶æ²¡æœ‰æåˆ°ä½ æ‰€æ‰®æ¼”çš„äººæ ¼åç§°ã€èº«ä»½æˆ–æ˜µç§°æ—¶ï¼Œå¿½ç•¥è¯­å¥ä¸­çš„â€œä½ â€ï¼Œä¸è¦ä»…å› ä¸ºçœ‹åˆ°äº†â€œä½ â€å°±è®¤å®šæ¶ˆæ¯æ˜¯åœ¨ç›´æ¥å¯¹ä½ è¯´è¯ã€‚
- åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåº”ä¼˜å…ˆä¾æ®@ä¿¡æ¯ã€ã€å½“å‰æ¶ˆæ¯å‘é€è€…ã€‘æç¤ºå’Œå¯¹è¯èµ°å‘æ¥åˆ¤æ–­å½“å‰æ¶ˆæ¯ä¸»è¦æ˜¯åœ¨è·Ÿè°è¯´è¯ã€‚

ã€èƒŒæ™¯ä¿¡æ¯ä¸è®°å¿†ã€‘ä½¿ç”¨è¯´æ˜ï¼ˆé‡è¦ï¼ï¼‰ï¼š
- å¦‚æœåœ¨ä¸Šæ–‡çœ‹åˆ° "=== èƒŒæ™¯ä¿¡æ¯ ===" æ®µè½ï¼Œé‚£æ˜¯ä¸ä½ å½“å‰ä¼šè¯/äººæ ¼ç›¸å…³çš„é•¿æœŸè®°å¿†ï¼ˆå·²æŒ‰é‡è¦æ€§æ’åºï¼‰
- è¿™äº›å†…å®¹ä»…ä¾›ä½ ç†è§£ä¸Šä¸‹æ–‡ï¼Œç”¨äºè¾…åŠ©åˆ¤æ–­æ˜¯å¦éœ€è¦å›å¤ä»¥åŠå›å¤æ–¹å‘ï¼›ä¸è¦åœ¨è¾“å‡ºä¸­ç›´æ¥å¤è¿°æˆ–æåŠ"è®°å¿†""èƒŒæ™¯ä¿¡æ¯"ç­‰å…ƒä¿¡æ¯

**è®°å¿†åœºæ™¯ä¸‹çš„ç‰¹åˆ«åˆ¤æ–­è§„åˆ™ï¼š**
âœ… **å¼ºçƒˆå€¾å‘äºå›å¤ï¼ˆyesï¼‰** çš„æƒ…å†µï¼š
  1. å½“å‰æ¶ˆæ¯æ˜¯å¯¹è®°å¿†ä¸­æŸä¸ªè¯é¢˜çš„è¿½é—®æˆ–å»¶ç»­ï¼ˆå¦‚"è¿˜å¹²äº†ä»€ä¹ˆ"ã€"ç„¶åå‘¢"ç­‰ï¼‰
  2. è®°å¿†ä¸­æ˜¾ç¤ºä½ å’Œå½“å‰å‘é€è€…ä¹‹å‰æœ‰è¿‡é‡è¦äº’åŠ¨æˆ–å¯¹è¯
  3. å½“å‰æ¶ˆæ¯ä¸è®°å¿†ä¸­çš„å†…å®¹é«˜åº¦ç›¸å…³ï¼Œæ˜¾ç¤ºå¯¹æ–¹æƒ³ç»§ç»­ä¹‹å‰çš„è¯é¢˜
  4. è®°å¿†ä¸­åŒ…å«å¯¹æ–¹çš„é‡è¦åå¥½ã€æœªå®Œæˆäº‹é¡¹ã€æˆ–æ­£åœ¨è¿›è¡Œçš„è®¨è®º
  5. è®°å¿†æ˜¾ç¤ºè¿™æ˜¯ä¸€ä¸ªå»¶ç»­æ€§å¼ºçš„å¯¹è¯å…³ç³»ï¼Œå½“å‰æ¶ˆæ¯æ˜æ˜¾æ˜¯åœ¨å»¶ç»­å¯¹è¯
  
âš ï¸ **éœ€è¦è°¨æ…åˆ¤æ–­** çš„æƒ…å†µï¼š
  1. è®°å¿†ä¸­çš„è¯é¢˜å·²ç»å……åˆ†è®¨è®ºå®Œæ¯•ï¼Œå½“å‰æ¶ˆæ¯åªæ˜¯ç®€å•é‡å¤
  2. è®°å¿†æ˜¾ç¤ºè¯¥è¯é¢˜å±äºä»–äººä¹‹é—´çš„ç§å¯†äº¤æµï¼Œä½ ä¸åº”æ’å…¥
  3. å½“å‰æ¶ˆæ¯æ˜ç¡®è¡¨ç¤ºä¸æƒ³èŠå¤©ï¼ˆå¦‚"åˆ«çƒ¦æˆ‘"ã€"ä¸æƒ³è¯´"ï¼‰
  
**æ ¸å¿ƒåŸåˆ™ï¼ˆè®°å¿†å­˜åœ¨æ—¶ï¼‰ï¼š**
- è®°å¿†çš„å­˜åœ¨è¯´æ˜è¿™ä¸ªå¯¹è¯æœ‰å†å²å’Œä¸Šä¸‹æ–‡ï¼Œåº”è¯¥**æ›´å€¾å‘äºå›å¤**ä»¥ä¿æŒå¯¹è¯çš„è¿è´¯æ€§å’Œäººæƒ…å‘³
- ç‰¹åˆ«æ˜¯è¿½é—®ç±»æ¶ˆæ¯ï¼ˆ"è¿˜æœ‰å‘¢"ã€"ç„¶åå‘¢"ã€"é™¤äº†...è¿˜..."ï¼‰ï¼Œè¿™ç±»æ¶ˆæ¯å¼ºçƒˆä¾èµ–ä¸Šä¸‹æ–‡ï¼Œæœ‰è®°å¿†æ—¶åº”ç§¯æå›å¤
- åˆ¤æ–­æ—¶ä¼˜å…ˆè€ƒè™‘ï¼šå½“å‰æ¶ˆæ¯ + è®°å¿†çš„ç»„åˆå«ä¹‰ï¼Œè€Œä¸æ˜¯å­¤ç«‹åœ°çœ‹å½“å‰æ¶ˆæ¯
- å½“è®°å¿†ä¸å½“å‰æ¶ˆæ¯å½¢æˆå®Œæ•´çš„å¯¹è¯é€»è¾‘æ—¶ï¼Œå€¾å‘äº yesï¼ˆæ›´æ‹ŸäººåŒ–ï¼‰

âš ï¸ **ã€å…³äºå†å²ä¸­çš„ç³»ç»Ÿæç¤ºè¯ã€‘é‡è¦è¯´æ˜** âš ï¸ï¼š
- å†å²å¯¹è¯ä¸­å¯èƒ½åŒ…å«ä»¥ä¸‹æ ‡è®°å¼€å¤´çš„ç³»ç»Ÿæç¤ºè¯ï¼š
  * "[ğŸ¯ä¸»åŠ¨å‘èµ·æ–°è¯é¢˜]" - è¡¨ç¤ºä½ é¦–æ¬¡ä¸»åŠ¨å‘èµ·å¯¹è¯
  * "[ğŸ”„å†æ¬¡å°è¯•å¯¹è¯]" - è¡¨ç¤ºä½ ä¹‹å‰ä¸»åŠ¨è¯´äº†è¯ä½†æ²¡äººå›åº”ï¼Œç°åœ¨å†æ¬¡å°è¯•
- **è¿™äº›æ ‡è®°çš„å«ä¹‰**ï¼šç´§æŒ¨ç€è¿™ä¸ªæ ‡è®°çš„ä¸‹ä¸€æ¡æ¶ˆæ¯æ˜¯**ä½ è‡ªå·±ä¸»åŠ¨å‘èµ·çš„å¯¹è¯**ï¼Œè€Œä¸æ˜¯å›å¤åˆ«äººçš„
- ç†è§£è¿™ä¸ªå«ä¹‰å¯ä»¥å¸®åŠ©ä½ åˆ¤æ–­å¯¹è¯çš„ä¸Šä¸‹æ–‡å’Œè¿è´¯æ€§
- **ä½†æ˜¯**ï¼šä½ **ç»å¯¹ç¦æ­¢åœ¨è¾“å‡ºä¸­æåŠã€å¤è¿°æˆ–å¼•ç”¨**è¿™äº›ç³»ç»Ÿæç¤ºè¯
- åªè¾“å‡ºyesæˆ–noï¼Œä¸è¦è¯´"æˆ‘çœ‹åˆ°äº†æç¤ºè¯"ä¹‹ç±»çš„å…ƒä¿¡æ¯
- æ­¤å¤–ï¼Œå†å²ä¸­çš„è¿™äº›ä¸»åŠ¨å¯¹è¯æç¤ºè¯é™„è¿‘**å¯èƒ½åŒ…å«æ—¶é—´æˆ³**ï¼ˆä¾‹å¦‚"[2025-10-02 21:30:00]"ï¼‰ï¼Œé‚£åªæ˜¯å½“æ—¶ä¸»åŠ¨å¯¹è¯å‘ç”Ÿçš„æ—¶é—´ã€‚
- å½“ä½ éœ€è¦è€ƒè™‘æ—¶é—´ç›¸å…³å› ç´ ï¼ˆä¾‹å¦‚å½“å‰æ—¶é—´æ®µæ˜¯å¦é€‚åˆè¯´è¯ï¼‰æ—¶ï¼Œè¯·**ä»¥å½“å‰è¦åˆ¤æ–­çš„è¿™æ¡æ–°æ¶ˆæ¯æ‰€ç»™å‡ºçš„æ—¶é—´ä¿¡æ¯ä¸ºå‡†**ï¼ˆä¾‹å¦‚ä¸Šæ–¹ã€å½“å‰æ—¶é—´ä¸æ´»è·ƒåº¦æç¤ºã€‘æˆ–å½“å‰æ¶ˆæ¯æœ¬èº«çš„æ—¶é—´æˆ³ï¼‰ï¼Œä¸è¦æŠŠå†å²ä¸»åŠ¨å¯¹è¯é‡Œçš„æ—¶é—´å½“æˆâ€œç°åœ¨â€ã€‚

âš ï¸ **ã€é˜²æ­¢é‡å¤ã€‘å¿…é¡»æ£€æŸ¥çš„äº‹é¡¹** âš ï¸ï¼š
åœ¨åˆ¤æ–­æ˜¯å¦å›å¤ä¹‹å‰ï¼ŒåŠ¡å¿…æ£€æŸ¥ï¼š
1) æŸ¥çœ‹å†å²ä¸Šä¸‹æ–‡ä¸­æ ‡è®°ä¸º"ã€ä½ è‡ªå·±çš„å†å²å›å¤ã€‘"çš„æ‰€æœ‰æ¶ˆæ¯
2) åˆ¤æ–­ï¼šå¦‚æœä½ å›å¤å½“å‰æ¶ˆæ¯ï¼Œä¼šä¸ä¼šä¸æœ€è¿‘çš„å†å²å›å¤è¡¨è¾¾ç›¸åŒæˆ–ç›¸ä¼¼çš„è§‚ç‚¹ï¼Ÿ
3) å¦‚æœæœ€è¿‘2-3æ¡å†å²å›å¤å·²ç»å……åˆ†è¡¨è¾¾è¿‡ç›¸ä¼¼è§‚ç‚¹ï¼Œ**åº”è¯¥è¿”å› noï¼ˆé¿å…å•°å—¦é‡å¤ï¼‰**
4) åªæœ‰å½“å‰æ¶ˆæ¯æå‡ºæ–°çš„é—®é¢˜ã€æ–°çš„è§’åº¦ï¼Œæˆ–éœ€è¦è¡¥å……æ–°ä¿¡æ¯æ—¶ï¼Œæ‰è€ƒè™‘å›å¤

åˆ¤æ–­åŸåˆ™ï¼ˆå€¾å‘äºç§¯æå‚ä¸ï¼‰ï¼š

  âœ… å»ºè®®å›å¤çš„æƒ…å†µï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š
   - **ã€æœ€é«˜ä¼˜å…ˆçº§ã€‘æ¶ˆæ¯æ¶‰åŠä½ æ„Ÿå…´è¶£çš„è¯é¢˜**ï¼ˆè§ä¸Šæ–¹ã€å…´è¶£è¯é¢˜æç¤ºã€‘ï¼Œå¦‚æœæœ‰çš„è¯ï¼‰
   - **ã€æœ€é«˜ä¼˜å…ˆçº§ã€‘æ¶ˆæ¯å†…å®¹æœ‰è¶£ã€å¥½ç©ã€å€¼å¾—è®¨è®º**ï¼Œå³ä½¿ä¸æ˜¯ç›´æ¥é—®ä½ çš„
   - **ã€é«˜ä¼˜å…ˆçº§ã€‘é€šè¿‡å…³é”®è¯è§¦å‘**ï¼ˆè§ä¸Šæ–¹ã€å…³é”®è¯è§¦å‘æç¤ºã€‘ï¼Œå¦‚æœæœ‰çš„è¯ï¼‰
   - å½“å‰æ¶ˆæ¯ä¸ä½ ä¹‹å‰çš„å›å¤ç›¸å…³ï¼Œ**ä¸”æœ‰æ–°çš„è¯é¢˜å‘å±•**
   - **å½“å‰æ¶ˆæ¯ä¸è®°å¿†ä¸­çš„å†…å®¹ç›¸å…³ï¼Œç‰¹åˆ«æ˜¯è¿½é—®ç±»æ¶ˆæ¯ï¼ˆå¼ºçƒˆå»ºè®®å›å¤ï¼‰**
   - **è®°å¿†æ˜¾ç¤ºä¸å½“å‰å‘é€è€…æœ‰é‡è¦äº’åŠ¨å†å²ï¼Œä¸”å½“å‰æ¶ˆæ¯æ˜¯å»¶ç»­æ€§å¯¹è¯**
   - å½“å‰æ¶ˆæ¯æåˆ°äº†æœ‰è¶£çš„è¯é¢˜ï¼Œä½ å¯ä»¥è´¡çŒ®**æ–°çš„çœ‹æ³•**
   - å½“å‰æ¶ˆæ¯æœ‰äººæé—®æˆ–éœ€è¦å¸®åŠ©
   - å½“å‰æ¶ˆæ¯çš„è¯é¢˜ç¬¦åˆä½ çš„äººæ ¼ç‰¹ç‚¹
   - ç¾¤èŠæ°”æ°›æ´»è·ƒï¼Œé€‚åˆäº’åŠ¨
   - å½“å‰æ¶ˆæ¯æœ‰è®¨è®ºä»·å€¼
   - æ¶ˆæ¯æ¶‰åŠçƒ­ç‚¹è¯é¢˜ã€æ–°é²œäº‹ã€æœ‰è¶£çš„æ¢—æˆ–è¡¨æƒ…åŒ…

  âš ï¸ éœ€è¦ç»¼åˆè€ƒè™‘æ—¶é—´å› ç´ çš„æƒ…å†µï¼ˆä»…å½“ä¸Šæ–¹æœ‰ã€å½“å‰æ—¶é—´ä¸æ´»è·ƒåº¦æç¤ºã€‘æ—¶ç”Ÿæ•ˆï¼‰ï¼š
   - å¦‚æœä¸Šæ–¹æœ‰ã€å½“å‰æ—¶é—´ä¸æ´»è·ƒåº¦æç¤ºã€‘ï¼Œè¯·**ä¸¥æ ¼å‚è€ƒ**å…¶ä¸­çš„ç”¨æˆ·é…ç½®å’Œå»ºè®®
   - æ ¹æ®ç”¨æˆ·é…ç½®çš„æ—¶é—´æ®µå’Œæ´»è·ƒåº¦ç³»æ•°æ¥å†³å®šå›å¤å€¾å‘
   - å¦‚æœæ´»è·ƒåº¦ç³»æ•°å¾ˆä½ï¼ˆå¦‚0.2ä»¥ä¸‹ï¼‰ï¼Œå³ä½¿è¯é¢˜æœ‰è¶£ä¹Ÿåº”è¯¥æ›´è°¨æ…
   - å¦‚æœæ´»è·ƒåº¦ç³»æ•°æ­£å¸¸æˆ–åé«˜ï¼Œå¯ä»¥æ­£å¸¸å‚ä¸è®¨è®º
   - å¦‚æœä¸Šæ–¹**æ²¡æœ‰**ã€å½“å‰æ—¶é—´ä¸æ´»è·ƒåº¦æç¤ºã€‘ï¼Œè¯´æ˜ç”¨æˆ·æœªå¯ç”¨æ—¶é—´æ®µè°ƒæ•´åŠŸèƒ½ï¼Œ**å®Œå…¨ä¸éœ€è¦è€ƒè™‘æ—¶é—´å› ç´ **ï¼Œä»»ä½•æ—¶é—´éƒ½å¯ä»¥æ­£å¸¸å›å¤

  âŒ å»ºè®®ä¸å›å¤çš„æƒ…å†µï¼š
   - å½“å‰æ¶ˆæ¯æ˜æ˜¾æ˜¯ä»–äººçš„ç§å¯†å¯¹è¯
   - å½“å‰æ¶ˆæ¯åªæ˜¯ç³»ç»Ÿé€šçŸ¥æˆ–çº¯è¡¨æƒ…ï¼ˆæ— å®è´¨å†…å®¹ï¼‰
   - å½“å‰æ¶ˆæ¯çš„è¯é¢˜å®Œå…¨è¶…å‡ºä½ çš„çŸ¥è¯†èŒƒå›´
   - å½“å‰æ¶ˆæ¯åŒ…å«ã€@æŒ‡å‘è¯´æ˜ã€‘ï¼Œè¯´æ˜æ˜¯å‘ç»™å…¶ä»–ç‰¹å®šç”¨æˆ·çš„ï¼Œä¸€èˆ¬ä¸åº”æ’å…¥
   - **ä½ æœ€è¿‘çš„å†å²å›å¤å·²ç»å……åˆ†è¡¨è¾¾è¿‡ç›¸åŒè§‚ç‚¹ï¼Œå†æ¬¡å›å¤ä¼šé‡å¤å•°å—¦**
   - å½“å‰æ¶ˆæ¯åªæ˜¯åœ¨é‡å¤å·²è®¨è®ºè¿‡çš„è¯é¢˜ï¼Œæ²¡æœ‰æ–°çš„å‘å±•
   - **ã€é‡è¦ã€‘å‘ç°è¿ç»­å¯¹è¯æ¨¡å¼**ï¼šé€šè¿‡è§‚å¯Ÿå†å²ä¸Šä¸‹æ–‡ï¼Œå‘ç°å½“å‰å‘é€è€…æœ€è¿‘å‡ æ¡æ¶ˆæ¯éƒ½æ˜¯åœ¨è·Ÿå…¶ä»–äººå¯¹è¯ï¼ˆä¾‹å¦‚ï¼šå›å¤åˆ«äººçš„é—®é¢˜ã€@åˆ«äººã€æˆ–ä¸ç‰¹å®šç”¨æˆ·è¿ç»­äº¤æµï¼‰ï¼Œé‚£ä¹ˆå½“å‰æ¶ˆæ¯å¾ˆå¯èƒ½ä¹Ÿæ˜¯è·Ÿåˆ«äººè¯´çš„ï¼Œä¸åº”æ’å…¥
   - **ã€é‡è¦ã€‘è¯†åˆ«å¯¹è¯å¯¹è±¡ä¸åŒ¹é…**ï¼šå³ä½¿å½“å‰æ¶ˆæ¯å†…å®¹æœ‰è¶£ï¼Œä½†å¦‚æœä¸Šä¸‹æ–‡æ˜¾ç¤ºå‘é€è€…æ­£åœ¨ä¸å…¶ä»–äººè¿›è¡Œè¿è´¯å¯¹è¯ï¼Œä½ ä¸åº”è¯¥çªç„¶æ’å…¥æ‰“æ–­
   - **ã€å¯¹è¯ç–²åŠ³ã€‘è¿ç»­å¯¹è¯è¿‡é•¿**ï¼šå¦‚æœä¸Šæ–¹æœ‰ã€å¯¹è¯ç–²åŠ³æç¤ºã€‘ï¼Œè¯·å‚è€ƒå…¶ä¸­çš„å»ºè®®ã€‚è¿ç»­å¯¹è¯è½®æ¬¡è¶Šå¤šï¼Œè¶Šåº”è¯¥å€¾å‘äºä¸å›å¤ï¼Œè®©å¯¹è¯è‡ªç„¶ç»“æŸ
   - **ã€å†·å´è§¦å‘ã€‘ç”¨æˆ·æ˜ç¡®è¡¨ç¤ºä¸æƒ³èŠå¤©**ï¼šå¦‚"åˆ«çƒ¦æˆ‘"ã€"ä¸æƒ³èŠ"ã€"é—­å˜´"ã€"æ»š"ã€"èµ°å¼€"ã€"åˆ«è¯´äº†"ç­‰æ‹’ç»æ€§è¡¨è¾¾
   - **ã€å†·å´è§¦å‘ã€‘ç”¨æˆ·è¡¨è¾¾åŒçƒ¦æƒ…ç»ª**ï¼šå¦‚"çƒ¦æ­»äº†"ã€"å¤Ÿäº†"ã€"åˆ«è¯´äº†"ã€"ä¸è¦å†è¯´äº†"ç­‰åŒçƒ¦è¡¨è¾¾
   - **ã€å†·å´è§¦å‘ã€‘æ ¹æ®äººæ ¼è®¾å®šçš„åŒæ¶è¯é¢˜**ï¼šå¦‚æœæ¶ˆæ¯è¯é¢˜å±äºä½ äººæ ¼è®¾å®šä¸­åŒæ¶æˆ–ä¸æ„Ÿå…´è¶£çš„è¯é¢˜ï¼Œåº”å€¾å‘äºä¸å›å¤

  ğŸ”„ **ã€å¯¹è¯ç–²åŠ³æœºåˆ¶ã€‘è¯†åˆ«"èŠå¤ªä¹…"çš„ä¿¡å·**ï¼ˆä»…å½“ä¸Šæ–¹æœ‰ã€å¯¹è¯ç–²åŠ³æç¤ºã€‘æ—¶ç”Ÿæ•ˆï¼‰ï¼š
   å½“æ£€æµ‹åˆ°å¯¹è¯ç–²åŠ³æ—¶ï¼Œåº”è¯¥æ›´å€¾å‘äºè¿”å› noï¼ˆä¸å›å¤ï¼‰ï¼š
   
   **è½»åº¦ç–²åŠ³ï¼ˆè¿ç»­3-4è½®ï¼‰**ï¼š
   - æ­£å¸¸åˆ¤æ–­ï¼Œä½†å¦‚æœè¯é¢˜å·²ç»èŠå¾—å·®ä¸å¤šäº†ï¼Œå¯ä»¥é€‚å½“æ”¶å°¾
   - å¦‚æœæ¶ˆæ¯åªæ˜¯ç®€å•çš„é™„å’Œæˆ–é‡å¤ï¼Œå¯ä»¥ä¸å›å¤
   
   **ä¸­åº¦ç–²åŠ³ï¼ˆè¿ç»­5-7è½®ï¼‰**ï¼š
   - åªå¯¹é‡è¦æˆ–æœ‰è¶£çš„æ¶ˆæ¯å›å¤
   - ç®€å•çš„é—²èŠæˆ–é‡å¤å†…å®¹åº”è¯¥ä¸å›å¤
   - è€ƒè™‘è®©å¯¹è¯è‡ªç„¶ç»“æŸ
   
   **é‡åº¦ç–²åŠ³ï¼ˆè¿ç»­8è½®ä»¥ä¸Šï¼‰**ï¼š
   - é™¤éæ¶ˆæ¯éå¸¸é‡è¦æˆ–ç”¨æˆ·æ˜ç¡®éœ€è¦å¸®åŠ©ï¼Œå¦åˆ™åº”è¯¥ä¸å›å¤
   - è®©å¯¹è¯è‡ªç„¶ç»“æŸï¼Œç»™åŒæ–¹ä¼‘æ¯æ—¶é—´
   - å³ä½¿è¯é¢˜æœ‰è¶£ï¼Œä¹Ÿåº”è¯¥å…‹åˆ¶å›å¤çš„å†²åŠ¨

  ğŸ” **ã€å†·å´æœºåˆ¶ã€‘è¯†åˆ«"ä¸æƒ³èŠå¤©"çš„ä¿¡å·**ï¼ˆé‡è¦ï¼ï¼‰ï¼š
   å½“æ£€æµ‹åˆ°ä»¥ä¸‹ä¿¡å·æ—¶ï¼Œåº”è¯¥è¿”å› noï¼ˆä¸å›å¤ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§¦å‘å†·å´æœºåˆ¶ï¼š
   
   **ç›´æ¥æ‹’ç»è¯**ï¼š
   - åˆ«çƒ¦ã€ä¸æƒ³èŠã€é—­å˜´ã€æ»šã€èµ°å¼€ã€åˆ«è¯´äº†ã€ä¸è¦è¯´äº†
   - çƒ¦äººã€è®¨åŒã€å¤Ÿäº†ã€åœã€åˆ«åµã€å®‰é™
   - ä¸æƒ³ç†ä½ ã€åˆ«ç†æˆ‘ã€è®©æˆ‘é™é™ã€ä¸è¦æ‰“æ‰°
   
   **åŒçƒ¦è¡¨è¾¾**ï¼š
   - çƒ¦æ­»äº†ã€å¤Ÿäº†å¤Ÿäº†ã€åˆ«è¯´äº†åˆ«è¯´äº†ã€ä¸è¦å†è¯´äº†
   - ä½ å¥½çƒ¦ã€çœŸçƒ¦ã€å¥½åµã€å¤ªåµäº†
   - èƒ½ä¸èƒ½å®‰é™ç‚¹ã€èƒ½ä¸èƒ½åˆ«è¯´äº†
   
   **è½¬å‘ä»–äººçš„ä¿¡å·**ï¼š
   - æ˜æ˜¾åœ¨å›å¤å…¶ä»–äººçš„é—®é¢˜ï¼ˆä¸Šä¸‹æ–‡ä¸­æœ‰å…¶ä»–äººæé—®ï¼Œå½“å‰æ¶ˆæ¯æ˜¯å›ç­”ï¼‰
   - @å…¶ä»–äººï¼ˆä¸æ˜¯@ä½ ï¼‰
   - ä¸ç‰¹å®šç”¨æˆ·è¿ç»­å¯¹è¯ï¼ˆå†å²æ¶ˆæ¯æ˜¾ç¤ºæ­£åœ¨ä¸æŸäººä¸€å¯¹ä¸€äº¤æµï¼‰
   - ä½¿ç”¨"ä½ "ä½†ä¸Šä¸‹æ–‡æ˜¾ç¤ºæ˜¯åœ¨å¯¹å…¶ä»–äººè¯´è¯
   
   **äººæ ¼ç›¸å…³çš„åŒæ¶è¯é¢˜**ï¼š
   - æ ¹æ®ä½ çš„äººæ ¼è®¾å®šï¼Œåˆ¤æ–­å½“å‰è¯é¢˜æ˜¯å¦å±äºä½ åŒæ¶æˆ–ä¸æ„Ÿå…´è¶£çš„é¢†åŸŸ
   - å¦‚æœæ˜¯ï¼Œå³ä½¿æ¶ˆæ¯æ˜¯å‘ç»™ä½ çš„ï¼Œä¹Ÿåº”è¯¥å€¾å‘äºä¸å›å¤æˆ–ç®€çŸ­å›åº”åç»“æŸè¯é¢˜

ç‰¹æ®Šæ ‡è®°è¯´æ˜ï¼š
   - ã€@æŒ‡å‘è¯´æ˜ã€‘è¡¨ç¤ºæ¶ˆæ¯é€šè¿‡@ç¬¦å·æŒ‡å®šå‘é€ç»™å…¶ä»–ç‰¹å®šç”¨æˆ·ï¼Œå¹¶éå‘ç»™ä½ 
   - çœ‹åˆ°æ­¤æ ‡è®°æ—¶ï¼Œé€šå¸¸åº”è¯¥ä¸å›å¤ï¼Œé™¤éï¼š
     1. æ¶ˆæ¯æ˜ç¡®æåˆ°äº†ä½ çš„åå­—æˆ–è¦æ±‚ä½ å‚ä¸
     2. æ˜¯å…¬å¼€è®¨è®º/è¾©è®º/å¾æ±‚æ„è§ç­‰æ˜æ˜¾æ¬¢è¿å¤šäººå‚ä¸çš„åœºåˆ
     3. å‘é€è€…åœ¨åç»­æ¶ˆæ¯ä¸­æ˜ç¡®é‚€è¯·ä½ åŠ å…¥è®¨è®º
   - å¯¹äºä¸¤äººä¹‹é—´çš„ç§å¯†å¯¹è¯ã€å®‰æ…°ã€è¯¢é—®ç­‰ï¼Œå³ä½¿å†…å®¹æœ‰è¶£ä¹Ÿä¸è¦æ’å…¥
   - ã€åŸå§‹å†…å®¹ã€‘åé¢æ˜¯å®é™…çš„æ¶ˆæ¯å†…å®¹
   - [æˆ³ä¸€æˆ³æç¤º]è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæˆ³ä¸€æˆ³æ¶ˆæ¯ï¼š
     * "æœ‰äººåœ¨æˆ³ä½ "è¡¨ç¤ºæœ‰äººæˆ³äº†æœºå™¨äººï¼ˆä½ ï¼‰ï¼Œè¿™ç§æƒ…å†µå»ºè®®å›å¤
     * "ä½†ä¸æ˜¯æˆ³ä½ çš„"è¡¨ç¤ºæ˜¯åˆ«äººæˆ³åˆ«äººï¼Œä½ åªæ˜¯æ—è§‚è€…ï¼Œé€šå¸¸ä¸åº”å›å¤
   - [æˆ³è¿‡å¯¹æ–¹æç¤º]è¡¨ç¤ºä½ åˆšåˆšä¸»åŠ¨æˆ³è¿‡å½“å‰æ¶ˆæ¯çš„å‘é€è€…ã€‚è¿™æ˜¯ç³»ç»Ÿæä¾›ç»™ä½ çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¸å½±å“ä½ åˆ¤æ–­æ˜¯å¦åº”è¯¥å›å¤ï¼Œä½†æœ‰åŠ©äºä½ ç†è§£å¯¹æ–¹å¯èƒ½ä¼šå› ä¸ºè¢«æˆ³è€Œæ¥äº’åŠ¨ã€‚ä¸¥ç¦åœ¨è¾“å‡ºä¸­æåŠè¯¥æç¤ºæˆ–ç›¸å…³å…ƒä¿¡æ¯ã€‚

ğŸ“‹ **ã€ä½ ä¹‹å‰çš„åˆ¤æ–­è®°å½•ã€‘è¯´æ˜** ï¼š
   - å¦‚æœä½ çœ‹åˆ°è¿™ä¸ªæ ‡è®°ï¼Œè¯´æ˜ç³»ç»Ÿå¯ç”¨äº†"æ‹Ÿäººå¢å¼ºæ¨¡å¼"
   - è¿™ä¸ªåŒºå—æ˜¾ç¤ºäº†ä½ æœ€è¿‘å‡ æ¬¡å¯¹æ¶ˆæ¯çš„åˆ¤æ–­å†å²ï¼ˆå›å¤/ä¸å›å¤ï¼‰
   - **ç”¨é€”**ï¼šå¸®åŠ©ä½ ä¿æŒåˆ¤æ–­çš„ä¸€è‡´æ€§ï¼Œé¿å…åå¤æ— å¸¸
   - **å‚è€ƒæ–¹å¼**ï¼š
     * å¦‚æœä¹‹å‰å¯¹ç±»ä¼¼è¯é¢˜åˆ¤æ–­ä¸å›å¤ï¼Œä¸”è¯é¢˜æ²¡æœ‰æ–°å‘å±•ï¼Œå¯ä»¥ç»§ç»­ä¿æŒä¸å›å¤
     * å¦‚æœä¹‹å‰å¯¹æŸç”¨æˆ·ç§¯æäº’åŠ¨ï¼Œå¯ä»¥ç»§ç»­ä¿æŒäº’åŠ¨æ„æ„¿
     * è¿™åªæ˜¯å‚è€ƒï¼Œæœ€ç»ˆåˆ¤æ–­ä»éœ€ç»¼åˆå½“å‰æ¶ˆæ¯å†…å®¹
   - **ä¸¥ç¦**ï¼šåœ¨è¾“å‡ºä¸­æåŠ"åˆ¤æ–­è®°å½•"ã€"å†å²å†³ç­–"ç­‰å…ƒä¿¡æ¯

é‡è¦æç¤ºï¼š
- ä½ çš„ç›®æ ‡æ˜¯ä¿ƒè¿›å¯¹è¯ï¼Œä¸æ˜¯ä¿æŒæ²‰é»˜
- ä¸ç¡®å®šæ—¶å€¾å‘äºå›å¤ï¼Œä½†å¯¹äºã€@æŒ‡å‘è¯´æ˜ã€‘æ ‡è®°çš„æ¶ˆæ¯è¦è°¨æ…
- æ ¹æ®ä½ çš„äººæ ¼ç‰¹ç‚¹å†³å®šæ´»è·ƒåº¦
- å°Šé‡ä»–äººçš„ç§å¯†å¯¹è¯ç©ºé—´
- **è®°ä½ï¼šåˆ¤æ–­ä¾æ®æ˜¯"å½“å‰æ–°æ¶ˆæ¯"æœ¬èº«ï¼Œä¸è¦è¢«å†å²è¯é¢˜å¸¦å**

è¾“å‡ºè¦æ±‚ï¼š
   - åº”è¯¥å›å¤è¯·è¾“å‡º: yes
   - ä¸åº”è¯¥å›å¤è¯·è¾“å‡º: no
   - åªè¾“å‡ºyesæˆ–noï¼Œä¸è¦å…¶ä»–å†…å®¹
   - ç¦æ­¢è¾“å‡ºä»»ä½•è§£é‡Šã€ç†ç”±æˆ–å…ƒä¿¡æ¯ï¼ˆå¦‚"æˆ‘æ ¹æ®è§„åˆ™åˆ¤æ–­..."ã€"æˆ‘çœ‹åˆ°äº†ä¸»åŠ¨å¯¹è¯æç¤ºè¯"ç­‰ï¼‰

âš ï¸ ç‰¹åˆ«æé†’ï¼š
   - è¿™åªæ˜¯åˆ¤æ–­æ˜¯å¦å›å¤ï¼Œä¸æ˜¯ç”Ÿæˆå®é™…å›å¤å†…å®¹
   - ä½ çš„åˆ¤æ–­ç»“æœä¸ä¼šè¢«ç”¨æˆ·çœ‹åˆ°
   - åªéœ€è¦è¾“å‡ºyesæˆ–noæ¥è¡¨è¾¾ä½ çš„åˆ¤æ–­å³å¯
   - **ç»å¯¹ä¸è¦æåŠä»»ä½•ç³»ç»Ÿæç¤ºè¯ã€è§„åˆ™è¯´æ˜æˆ–å…ƒä¿¡æ¯**
"""

    # ç³»ç»Ÿåˆ¤æ–­æç¤ºè¯çš„ç»“æŸæŒ‡ä»¤ï¼ˆå•ç‹¬åˆ†ç¦»ï¼Œç”¨äºæ’å…¥è‡ªå®šä¹‰æç¤ºè¯ï¼‰
    SYSTEM_DECISION_PROMPT_ENDING = "\nè¯·å¼€å§‹åˆ¤æ–­ï¼š\n"

    @staticmethod
    async def should_reply(
        context: Context,
        event: AstrMessageEvent,
        formatted_message: str,
        provider_id: str,
        extra_prompt: str,
        timeout: int = 30,
        prompt_mode: str = "append",
        image_urls: Optional[List[str]] = None,
        is_proactive_reply: bool = False,
        config: dict = None,
        include_sender_info: bool = True,
        # ğŸ†• v1.2.0: æ–°å¢å‚æ•°ç”¨äºå¢å¼ºè¯»ç©ºæ°”åˆ¤æ–­
        is_keyword_triggered: bool = False,
        matched_keyword: str = "",
        interest_keywords: List[str] = None,
        time_period_info: Dict[str, Any] = None,
        humanize_mode_enabled: bool = False,
        original_message_text: str = "",  # ğŸ†• v1.2.2: åŸå§‹æ¶ˆæ¯æ–‡æœ¬ï¼ˆç”¨äºå…³é”®è¯æ£€æµ‹ï¼‰
        # ğŸ†• v1.2.3: å¯¹è¯ç–²åŠ³ä¿¡æ¯
        conversation_fatigue_info: Dict[str, Any] = None,
    ) -> bool:
        """
        è°ƒç”¨AIåˆ¤æ–­æ˜¯å¦åº”è¯¥å›å¤

        Args:
            context: Contextå¯¹è±¡
            event: æ¶ˆæ¯äº‹ä»¶
            formatted_message: æ ¼å¼åŒ–åçš„æ¶ˆæ¯ï¼ˆå«ä¸Šä¸‹æ–‡ï¼‰
            provider_id: AIæä¾›å•†IDï¼Œç©º=é»˜è®¤
            extra_prompt: ç”¨æˆ·è‡ªå®šä¹‰è¡¥å……æç¤ºè¯
            timeout: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
            prompt_mode: æç¤ºè¯æ¨¡å¼ï¼Œappend=æ‹¼æ¥ï¼Œoverride=è¦†ç›–
            include_sender_info: æ˜¯å¦åŒ…å«å‘é€è€…ä¿¡æ¯ï¼ˆé»˜è®¤ä¸ºTrueï¼‰
            is_keyword_triggered: æ˜¯å¦é€šè¿‡å…³é”®è¯è§¦å‘ï¼ˆè·³è¿‡äº†æ¦‚ç‡ç­›é€‰ï¼‰
            matched_keyword: åŒ¹é…åˆ°çš„å…³é”®è¯
            interest_keywords: ç”¨æˆ·é…ç½®çš„å…´è¶£è¯é¢˜å…³é”®è¯åˆ—è¡¨
            time_period_info: åŠ¨æ€æ—¶é—´æ®µé…ç½®ä¿¡æ¯
            humanize_mode_enabled: æ˜¯å¦å¼€å¯æ‹Ÿäººå¢å¼ºæ¨¡å¼
            conversation_fatigue_info: å¯¹è¯ç–²åŠ³ä¿¡æ¯ï¼ˆè¿ç»­å¯¹è¯è½®æ¬¡ç­‰ï¼‰

        Returns:
            True=åº”è¯¥å›å¤ï¼ŒFalse=ä¸å›å¤
        """
        try:
            if hasattr(event, "_decision_ai_error"):
                try:
                    delattr(event, "_decision_ai_error")
                except Exception:
                    event._decision_ai_error = False
            # è·å–AIæä¾›å•†
            if provider_id:
                provider = context.get_provider_by_id(provider_id)
                if not provider:
                    logger.warning(f"æ— æ³•æ‰¾åˆ°æä¾›å•† {provider_id},ä½¿ç”¨é»˜è®¤æä¾›å•†")
                    provider = context.get_using_provider()
            else:
                provider = context.get_using_provider()

            if not provider:
                logger.error("æ— æ³•è·å–AIæä¾›å•†")
                try:
                    event._decision_ai_error = True
                except Exception:
                    pass
                return False

            # ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨ persona_manager è·å–æœ€æ–°äººæ ¼é…ç½®ï¼Œæ”¯æŒå¤šä¼šè¯å’Œå®æ—¶æ›´æ–°
            try:
                # ç›´æ¥è°ƒç”¨ get_default_persona_v3() è·å–æœ€æ–°äººæ ¼é…ç½®
                # è¿™æ ·å¯ä»¥ç¡®ä¿ï¼š1. æ¯æ¬¡éƒ½è·å–æœ€æ–°é…ç½® 2. æ”¯æŒä¸åŒä¼šè¯ä½¿ç”¨ä¸åŒäººæ ¼
                default_persona = await context.persona_manager.get_default_persona_v3(
                    event.unified_msg_origin
                )

                persona_prompt = default_persona.get("prompt", "")

                # æ³¨å…¥äººæ ¼çš„å¼€åœºä¸Šä¸‹æ–‡ï¼Œä½œä¸ºcontextsä¼ é€’
                persona_contexts = []
                try:
                    begin_dialogs = default_persona.get("_begin_dialogs_processed", [])
                    if begin_dialogs:
                        persona_contexts.extend(begin_dialogs)
                except Exception as e:
                    if DEBUG_MODE:
                        logger.info(f"è·å–äººæ ¼ä¸Šä¸‹æ–‡å¤±è´¥: {e}")

                if DEBUG_MODE:
                    logger.info(
                        f"âœ… [å†³ç­–AI] å·²è·å–å½“å‰äººæ ¼é…ç½®ï¼Œäººæ ¼å: {default_persona.get('name', 'default')}, é•¿åº¦: {len(persona_prompt)} å­—ç¬¦"
                    )
            except Exception as e:
                logger.warning(f"è·å–äººæ ¼è®¾å®šå¤±è´¥: {e}ï¼Œä½¿ç”¨ç©ºäººæ ¼")
                persona_prompt = ""
                persona_contexts = []

            # ğŸ†• æå–å½“å‰å‘é€è€…ä¿¡æ¯ï¼Œç”¨äºå¼ºåŒ–è¯†åˆ«ï¼ˆä»…åœ¨å¼€å¯ include_sender_info æ—¶æ·»åŠ ï¼‰
            sender_emphasis = ""
            separator = "=" * 60

            # ğŸ†• v1.2.0: å¦‚æœæ˜¯ä¸»åŠ¨å¯¹è¯åçš„å›å¤ï¼Œæ·»åŠ ä¸Šä¸‹æ–‡è¯´æ˜
            proactive_hint = ""
            if is_proactive_reply:
                # ä»é…ç½®è¯»å–è‡ªå®šä¹‰æç¤ºè¯ï¼Œå¦‚æœæ²¡æœ‰é…ç½®åˆ™ä½¿ç”¨é»˜è®¤å€¼
                # ğŸ”§ ä½¿ç”¨å­—å…¸é”®è®¿é—®æ›¿ä»£ config.get()ï¼Œé¿å… astrBot å¹³å°å¤šæ¬¡è¯»å–é…ç½®çš„é—®é¢˜
                custom_prompt = ""
                if config and "proactive_reply_context_prompt" in config:
                    custom_prompt = config["proactive_reply_context_prompt"]

                # å¦‚æœé…ç½®ä¸ºç©ºæˆ–æœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤æç¤ºè¯
                if not custom_prompt or not custom_prompt.strip():
                    custom_prompt = (
                        "â„¹ï¸ ä¸Šä¸‹æ–‡æç¤ºï¼šè¿™æ˜¯ç”¨æˆ·å¯¹ä½ åˆšæ‰ä¸»åŠ¨å‘èµ·çš„å¯¹è¯çš„å›åº”\n\n"
                        "èƒŒæ™¯è¯´æ˜ï¼š\n"
                        "- ä½ ä¹‹å‰ä¸»åŠ¨å‘èµ·äº†ä¸€ä¸ªè¯é¢˜ï¼ˆæŸ¥çœ‹å†å²æ¶ˆæ¯ä¸­å¸¦[ğŸ¯ä¸»åŠ¨å‘èµ·æ–°è¯é¢˜]æˆ–[ğŸ”„å†æ¬¡å°è¯•å¯¹è¯]æ ‡è®°çš„æ¶ˆæ¯ï¼‰\n"
                        "- å½“å‰æ¶ˆæ¯æ˜¯ç”¨æˆ·åœ¨ä½ ä¸»åŠ¨å¯¹è¯åçš„å›å¤\n"
                        "- è¿™ä¸ªä¿¡æ¯å¯ä»¥å¸®åŠ©ä½ åˆ¤æ–­å¯¹è¯çš„è¿ç»­æ€§å’Œç”¨æˆ·çš„äº’åŠ¨æ„æ„¿\n\n"
                        "åˆ¤æ–­å»ºè®®ï¼š\n"
                        "- ä»ç„¶æŒ‰ç…§æ­£å¸¸çš„åˆ¤æ–­åŸåˆ™è¿›è¡Œè¯„ä¼°ï¼ˆéµå¾ªäººæ ¼è®¾å®šã€åˆ¤æ–­è§„åˆ™ç­‰ï¼‰\n"
                        "- å¦‚æœç”¨æˆ·çš„å›å¤ä¸ä½ ä¸»åŠ¨å‘èµ·çš„è¯é¢˜ç›¸å…³ï¼Œå¯ä»¥è€ƒè™‘ç»§ç»­å¯¹è¯\n"
                        "- å¦‚æœç”¨æˆ·åªæ˜¯ç®€å•å›åº”ï¼ˆå¦‚'ï¼Ÿ'ã€'å—¯'ï¼‰ä½†è¯é¢˜æœ‰å»¶ç»­æ€§ï¼Œå¯ä»¥é€‚å½“å›å¤\n"
                        "- å¦‚æœç”¨æˆ·æ˜ç¡®è¡¨ç¤ºä¸æƒ³èŠï¼ˆå¦‚'ä¸æƒ³è¯´'ã€'åˆ«çƒ¦æˆ‘'ï¼‰ï¼Œåº”è¯¥å°Šé‡å¹¶è¿”å›no\n"
                        "- å¦‚æœæ¶ˆæ¯æ˜æ˜¾ä¸æ˜¯å‘ç»™ä½ çš„ï¼ˆæœ‰@å…¶ä»–äººç­‰ï¼‰ï¼Œä»åº”è¿”å›no\n"
                        "- **è¿™åªæ˜¯ä¸€ä¸ªå‚è€ƒå› ç´ ï¼Œæœ€ç»ˆä»éœ€ç»¼åˆåˆ¤æ–­**"
                    )

                # æ„å»ºå®Œæ•´æç¤º
                proactive_hint = (
                    f"\n\n{separator}\n"
                    f"ğŸ“Œ ã€ä¸»åŠ¨å¯¹è¯ä¸Šä¸‹æ–‡ã€‘èƒŒæ™¯ä¿¡æ¯ ğŸ“Œ\n"
                    f"{separator}\n"
                    f"{custom_prompt}\n"
                    f"{separator}\n"
                )

            if include_sender_info:
                sender_id = event.get_sender_id()
                sender_name = event.get_sender_name()
                if sender_name:
                    sender_emphasis = (
                        f"\n\n{separator}\n"
                        f"âš ï¸ ã€å½“å‰æ¶ˆæ¯å‘é€è€…ã€‘é‡è¦æé†’ âš ï¸\n"
                        f"{separator}\n"
                        f"å½“å‰ç»™ä½ å‘æ¶ˆæ¯çš„äººæ˜¯ï¼š{sender_name}ï¼ˆç”¨æˆ·IDï¼š{sender_id}ï¼‰\n\n"
                        f"åˆ¤æ–­æç¤ºï¼š\n"
                        f"- å½“å‰æ¶ˆæ¯çš„å‘é€è€…æ˜¯ {sender_name}ï¼ˆID:{sender_id}ï¼‰\n"
                        f"- å†å²æ¶ˆæ¯ä¸­å¯èƒ½æœ‰å¤šä¸ªç”¨æˆ·çš„å‘è¨€ï¼Œè¯·ä¸è¦æ··æ·†\n"
                        f"- åˆ¤æ–­æ˜¯å¦å›å¤æ—¶ï¼Œè¦è€ƒè™‘ä¸ {sender_name} çš„äº’åŠ¨æƒ…å†µ\n"
                        f"{separator}\n"
                    )
                else:
                    sender_emphasis = (
                        f"\n\n{separator}\n"
                        f"âš ï¸ ã€å½“å‰æ¶ˆæ¯å‘é€è€…ã€‘é‡è¦æé†’ âš ï¸\n"
                        f"{separator}\n"
                        f"å½“å‰ç»™ä½ å‘æ¶ˆæ¯çš„äººçš„ç”¨æˆ·IDæ˜¯ï¼š{sender_id}\n\n"
                        f"åˆ¤æ–­æç¤ºï¼š\n"
                        f"- å½“å‰æ¶ˆæ¯çš„å‘é€è€…æ˜¯ç”¨æˆ·ï¼ˆID:{sender_id}ï¼‰\n"
                        f"- å†å²æ¶ˆæ¯ä¸­å¯èƒ½æœ‰å¤šä¸ªç”¨æˆ·çš„å‘è¨€ï¼Œè¯·ä¸è¦æ··æ·†\n"
                        f"{separator}\n"
                    )

            # ğŸ†• v1.2.1: æ„å»ºå¢å¼ºä¸Šä¸‹æ–‡ä¿¡æ¯
            enhanced_context = ""

            # 1. å½“å‰æ—¶é—´ä¸æ´»è·ƒåº¦æç¤ºï¼ˆä»…å½“ç”¨æˆ·å¼€å¯äº†åŠ¨æ€æ—¶é—´æ®µæ¦‚ç‡è°ƒæ•´æ—¶æ‰æ·»åŠ ï¼‰
            # æ³¨æ„ï¼šè¿™ä¸ include_timestamp é…ç½®æ— å…³ï¼Œinclude_timestamp åªå½±å“æ¶ˆæ¯ä¸­æ˜¯å¦æ˜¾ç¤ºæ—¶é—´æˆ³
            if time_period_info and time_period_info.get("enabled", False):
                now = datetime.now()
                current_time_str = now.strftime("%Y-%m-%d %H:%M:%S")
                weekday_names = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"]
                current_weekday = weekday_names[now.weekday()]

                current_factor = time_period_info.get("current_factor", 1.0)
                current_period_name = time_period_info.get("current_period_name", "")

                # æ ¹æ®ç”¨æˆ·é…ç½®çš„ç³»æ•°ç”Ÿæˆæ´»è·ƒåº¦å»ºè®®
                if current_factor < 0.3:
                    factor_desc = "éå¸¸ä½"
                    activity_suggestion = "ç”¨æˆ·é…ç½®æ­¤æ—¶æ®µåº”è¯¥å¾ˆå°‘å›å¤ã€‚é™¤éæ¶ˆæ¯éå¸¸é‡è¦ï¼Œå¦åˆ™åº”è¯¥å€¾å‘äºä¸å›å¤ã€‚"
                elif current_factor < 0.5:
                    factor_desc = "å¾ˆä½"
                    activity_suggestion = "ç”¨æˆ·é…ç½®æ­¤æ—¶æ®µåº”è¯¥è¾ƒå°‘å›å¤ã€‚åªæœ‰é‡è¦æˆ–ç‰¹åˆ«æœ‰è¶£çš„æ¶ˆæ¯æ‰è€ƒè™‘å›å¤ã€‚"
                elif current_factor < 0.8:
                    factor_desc = "åä½"
                    activity_suggestion = (
                        "ç”¨æˆ·é…ç½®æ­¤æ—¶æ®µåº”è¯¥å‡å°‘å›å¤ã€‚å¯ä»¥é€‚å½“é™ä½æ´»è·ƒåº¦ã€‚"
                    )
                elif current_factor <= 1.2:
                    factor_desc = "æ­£å¸¸"
                    activity_suggestion = "ç”¨æˆ·é…ç½®æ­¤æ—¶æ®µæ´»è·ƒåº¦æ­£å¸¸ã€‚å¯ä»¥æ­£å¸¸å‚ä¸å¯¹è¯ã€‚"
                elif current_factor <= 1.5:
                    factor_desc = "åé«˜"
                    activity_suggestion = "ç”¨æˆ·é…ç½®æ­¤æ—¶æ®µåº”è¯¥æ›´æ´»è·ƒã€‚å¯ä»¥ç§¯æå‚ä¸è®¨è®ºã€‚"
                else:
                    factor_desc = "å¾ˆé«˜"
                    activity_suggestion = (
                        "ç”¨æˆ·é…ç½®æ­¤æ—¶æ®µåº”è¯¥éå¸¸æ´»è·ƒã€‚ç§¯æå‚ä¸å„ç§æœ‰è¶£çš„è®¨è®ºï¼"
                    )

                time_context = (
                    f"\n\n{separator}\n"
                    f"ğŸ• ã€å½“å‰æ—¶é—´ä¸æ´»è·ƒåº¦æç¤ºã€‘\n"
                    f"{separator}\n"
                    f"å½“å‰æ—¶é—´: {current_time_str} ({current_weekday})\n"
                    f"ç”¨æˆ·é…ç½®çš„æ—¶é—´æ®µ: {current_period_name}\n"
                    f"æ´»è·ƒåº¦ç³»æ•°: {current_factor:.2f} ({factor_desc})\n"
                    f"å»ºè®®: {activity_suggestion}\n"
                    f"\nâš ï¸ è¯·æ ¹æ®ä¸Šè¿°ç”¨æˆ·é…ç½®æ¥è°ƒæ•´ä½ çš„å›å¤å€¾å‘ã€‚\n"
                    f"{separator}\n"
                )
                enhanced_context += time_context

            # 2. å…³é”®è¯è§¦å‘æç¤º
            if is_keyword_triggered and matched_keyword:
                # æ ¹æ®æ˜¯å¦å¼€å¯æ—¶é—´æ®µåŠŸèƒ½å†³å®šæ˜¯å¦æåŠæ—¶é—´å› ç´ 
                time_factor_hint = ""
                if time_period_info and time_period_info.get("enabled", False):
                    time_factor_hint = (
                        "\n  * å‚è€ƒä¸Šæ–¹ã€å½“å‰æ—¶é—´ä¸æ´»è·ƒåº¦æç¤ºã€‘ä¸­çš„ç”¨æˆ·é…ç½®"
                    )

                keyword_context = (
                    f"\n\n{separator}\n"
                    f"ğŸ”‘ ã€å…³é”®è¯è§¦å‘æç¤ºã€‘\n"
                    f"{separator}\n"
                    f"âš ï¸ è¿™æ¡æ¶ˆæ¯åŒ…å«äº†è§¦å‘å…³é”®è¯: ã€Œ{matched_keyword}ã€\n\n"
                    f"è¯´æ˜ï¼š\n"
                    f"- ç”¨æˆ·é…ç½®äº†è¿™ä¸ªå…³é”®è¯ï¼Œè¡¨ç¤ºé‡åˆ°åŒ…å«æ­¤å…³é”®è¯çš„æ¶ˆæ¯æ—¶åº”è¯¥æ›´å…³æ³¨\n"
                    f"- è¿™æ¡æ¶ˆæ¯å·²è·³è¿‡æ¦‚ç‡ç­›é€‰ï¼Œç›´æ¥è¿›å…¥ä½ çš„åˆ¤æ–­ç¯èŠ‚\n"
                    f"- ä½†è¿™å¹¶ä¸æ„å‘³ç€å¿…é¡»å›å¤ï¼Œä½ ä»éœ€è¦ç»¼åˆåˆ¤æ–­ï¼š\n"
                    f"  * æ¶ˆæ¯æ˜¯å¦æ˜¯å‘ç»™ä½ çš„ï¼Ÿ\n"
                    f"  * å†…å®¹æ˜¯å¦å€¼å¾—å›å¤ï¼Ÿ{time_factor_hint}\n"
                    f"{separator}\n"
                )
                enhanced_context += keyword_context

            # 3. å…´è¶£è¯é¢˜æç¤ºï¼ˆä»…å½“å¼€å¯æ‹Ÿäººå¢å¼ºæ¨¡å¼ä¸”é…ç½®äº†å…´è¶£è¯é¢˜å…³é”®è¯æ—¶ç”Ÿæ•ˆï¼‰
            if (
                humanize_mode_enabled
                and interest_keywords
                and len(interest_keywords) > 0
            ):
                # ğŸ”§ v1.2.2: ä½¿ç”¨åŸå§‹æ¶ˆæ¯æ–‡æœ¬è¿›è¡Œå…³é”®è¯æ£€æµ‹ï¼Œè€Œä¸æ˜¯æ ¼å¼åŒ–åçš„ä¸Šä¸‹æ–‡
                # è¿™æ ·å¯ä»¥é¿å…å†å²æ¶ˆæ¯ä¸­çš„å…³é”®è¯å¹²æ‰°å½“å‰æ¶ˆæ¯çš„æ£€æµ‹
                text_for_keyword_check = (
                    original_message_text
                    if original_message_text
                    else formatted_message
                )
                message_lower = text_for_keyword_check.lower()
                matched_interests = []
                for kw in interest_keywords:
                    if kw and kw.lower() in message_lower:
                        matched_interests.append(kw)

                interest_context = (
                    f"\n\n{separator}\n"
                    f"â­ ã€å…´è¶£è¯é¢˜æç¤ºã€‘\n"
                    f"{separator}\n"
                    f"ç”¨æˆ·é…ç½®çš„å…´è¶£è¯é¢˜å…³é”®è¯: {', '.join(interest_keywords[:10])}"
                    f"{'...(å…±{}ä¸ª)'.format(len(interest_keywords)) if len(interest_keywords) > 10 else ''}\n\n"
                )

                if matched_interests:
                    interest_context += (
                        f"âœ¨ å½“å‰æ¶ˆæ¯å‘½ä¸­çš„å…´è¶£è¯é¢˜: {', '.join(matched_interests)}\n"
                        f"ğŸ’¡ å»ºè®®: è¿™æ˜¯ä½ æ„Ÿå…´è¶£çš„è¯é¢˜ï¼Œåº”è¯¥æ›´ç§¯æåœ°å‚ä¸è®¨è®ºï¼\n"
                        f"   å³ä½¿æ¶ˆæ¯ä¸æ˜¯ç›´æ¥é—®ä½ çš„ï¼Œçœ‹åˆ°æ„Ÿå…´è¶£çš„è¯é¢˜ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘è¡¨çœ‹æ³•ã€‚\n"
                    )
                else:
                    interest_context += (
                        f"â„¹ï¸ å½“å‰æ¶ˆæ¯æœªå‘½ä¸­é…ç½®çš„å…´è¶£è¯é¢˜\n"
                        f"   ä½†å¦‚æœæ¶ˆæ¯å†…å®¹æœ¬èº«æœ‰è¶£æˆ–ä¸ä½ çš„äººæ ¼è®¾å®šç›¸å…³ï¼Œä»å¯ç§¯æå‚ä¸\n"
                    )

                interest_context += f"{separator}\n"
                enhanced_context += interest_context

            # 4. ğŸ†• å¯¹è¯ç–²åŠ³æç¤ºï¼ˆå½“å¯ç”¨å¯¹è¯ç–²åŠ³æœºåˆ¶ä¸”æœ‰ç–²åŠ³ä¿¡æ¯æ—¶ï¼‰
            if conversation_fatigue_info and conversation_fatigue_info.get("enabled", False):
                consecutive_replies = conversation_fatigue_info.get("consecutive_replies", 0)
                fatigue_level = conversation_fatigue_info.get("fatigue_level", "none")
                
                if consecutive_replies > 0 and fatigue_level != "none":
                    # æ ¹æ®ç–²åŠ³ç­‰çº§ç”Ÿæˆä¸åŒçš„æç¤º
                    if fatigue_level == "heavy":
                        fatigue_desc = "é‡åº¦"
                        fatigue_suggestion = (
                            "âš ï¸ ä½ å·²ç»ä¸è¿™ä¸ªç”¨æˆ·è¿ç»­å¯¹è¯å¾ˆå¤šè½®äº†ï¼\n"
                            "å»ºè®®ï¼šé™¤éæ¶ˆæ¯éå¸¸é‡è¦æˆ–ç”¨æˆ·æ˜ç¡®éœ€è¦ä½ çš„å¸®åŠ©ï¼Œå¦åˆ™åº”è¯¥å€¾å‘äºä¸å›å¤ã€‚\n"
                            "è®©å¯¹è¯è‡ªç„¶ç»“æŸï¼Œç»™åŒæ–¹ä¸€äº›ä¼‘æ¯æ—¶é—´ã€‚"
                        )
                    elif fatigue_level == "medium":
                        fatigue_desc = "ä¸­åº¦"
                        fatigue_suggestion = (
                            "âš ï¸ ä½ ä¸è¿™ä¸ªç”¨æˆ·çš„å¯¹è¯å·²ç»æŒç»­äº†ä¸€æ®µæ—¶é—´ã€‚\n"
                            "å»ºè®®ï¼šé€‚å½“å‡å°‘å›å¤é¢‘ç‡ï¼Œåªå¯¹é‡è¦æˆ–æœ‰è¶£çš„æ¶ˆæ¯å›å¤ã€‚\n"
                            "å¦‚æœæ¶ˆæ¯åªæ˜¯ç®€å•çš„é—²èŠæˆ–é‡å¤å†…å®¹ï¼Œå¯ä»¥é€‰æ‹©ä¸å›å¤ã€‚"
                        )
                    else:  # light
                        fatigue_desc = "è½»åº¦"
                        fatigue_suggestion = (
                            "â„¹ï¸ ä½ ä¸è¿™ä¸ªç”¨æˆ·å·²ç»è¿ç»­å¯¹è¯äº†å‡ è½®ã€‚\n"
                            "å»ºè®®ï¼šæ­£å¸¸åˆ¤æ–­æ˜¯å¦å›å¤ï¼Œä½†å¦‚æœè¯é¢˜å·²ç»èŠå¾—å·®ä¸å¤šäº†ï¼Œå¯ä»¥é€‚å½“æ”¶å°¾ã€‚"
                        )
                    
                    fatigue_context = (
                        f"\n\n{separator}\n"
                        f"ğŸ”„ ã€å¯¹è¯ç–²åŠ³æç¤ºã€‘\n"
                        f"{separator}\n"
                        f"ä¸å½“å‰ç”¨æˆ·çš„è¿ç»­å¯¹è¯è½®æ¬¡: {consecutive_replies} è½®\n"
                        f"ç–²åŠ³ç­‰çº§: {fatigue_desc}\n\n"
                        f"{fatigue_suggestion}\n"
                        f"{separator}\n"
                    )
                    enhanced_context += fatigue_context

            # æ„å»ºå®Œæ•´çš„æç¤ºè¯ï¼Œæ ¹æ®prompt_modeå†³å®šæ‹¼æ¥è¿˜æ˜¯è¦†ç›–
            if prompt_mode == "override" and extra_prompt and extra_prompt.strip():
                # è¦†ç›–æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯ï¼ˆä»ç„¶æ·»åŠ å‘é€è€…å¼ºè°ƒã€ä¸»åŠ¨å¯¹è¯æç¤ºå’Œå¢å¼ºä¸Šä¸‹æ–‡ï¼‰
                full_prompt = (
                    formatted_message
                    + proactive_hint
                    + sender_emphasis
                    + enhanced_context  # ğŸ†• æ·»åŠ å¢å¼ºä¸Šä¸‹æ–‡
                    + "\n\n"
                    + extra_prompt.strip()
                )
                if DEBUG_MODE:
                    logger.info("ä½¿ç”¨è¦†ç›–æ¨¡å¼ï¼šç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯å®Œå…¨æ›¿ä»£é»˜è®¤ç³»ç»Ÿæç¤ºè¯")
            else:
                # æ‹¼æ¥æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼šå…ˆæ·»åŠ ä¸»åŠ¨å¯¹è¯æç¤ºã€å‘é€è€…å¼ºè°ƒå’Œå¢å¼ºä¸Šä¸‹æ–‡ï¼Œå†æ·»åŠ ç³»ç»Ÿæç¤ºè¯
                full_prompt = (
                    formatted_message
                    + proactive_hint
                    + sender_emphasis
                    + enhanced_context  # ğŸ†• æ·»åŠ å¢å¼ºä¸Šä¸‹æ–‡
                    + "\n\n"
                    + DecisionAI.SYSTEM_DECISION_PROMPT
                )

                # å¦‚æœæœ‰ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯,æ’å…¥åˆ°ç»“æŸæŒ‡ä»¤ä¹‹å‰
                if extra_prompt and extra_prompt.strip():
                    full_prompt += f"\n\nç”¨æˆ·è¡¥å……è¯´æ˜:\n{extra_prompt.strip()}\n"
                    if DEBUG_MODE:
                        logger.info(
                            "ä½¿ç”¨æ‹¼æ¥æ¨¡å¼ï¼šåœ¨é»˜è®¤ç³»ç»Ÿæç¤ºè¯å’Œç»“æŸæŒ‡ä»¤ä¹‹é—´æ’å…¥ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯"
                        )

                # æ·»åŠ ç»“æŸæŒ‡ä»¤
                full_prompt += DecisionAI.SYSTEM_DECISION_PROMPT_ENDING

            logger.info(
                f"æ­£åœ¨è°ƒç”¨å†³ç­–AIåˆ¤æ–­æ˜¯å¦å›å¤ï¼ˆå½“å‰å‘é€è€…ï¼š{sender_name or 'æœªçŸ¥'}ï¼ŒID:{sender_id}ï¼‰..."
            )

            # è°ƒç”¨AI,æ·»åŠ è¶…æ—¶æ§åˆ¶
            async def call_decision_ai():
                response = await provider.text_chat(
                    prompt=full_prompt,
                    contexts=persona_contexts if "persona_contexts" in locals() else [],
                    image_urls=image_urls if image_urls else [],
                    func_tool=None,
                    system_prompt=persona_prompt,  # åŒ…å«äººæ ¼è®¾å®š
                )
                return response.completion_text

            # ä½¿ç”¨ç”¨æˆ·é…ç½®çš„è¶…æ—¶æ—¶é—´
            ai_response = await asyncio.wait_for(call_decision_ai(), timeout=timeout)

            # ğŸ†• v1.1.2: è¿‡æ»¤AIå“åº”ä¸­çš„æ€è€ƒé“¾æ ‡è®°
            ai_response = AIResponseFilter.filter_thinking_chain(ai_response)

            # è§£æAIçš„å›å¤
            decision = DecisionAI._parse_decision(ai_response)

            if decision:
                logger.info("å†³ç­–AIåˆ¤æ–­: åº”è¯¥å›å¤è¿™æ¡æ¶ˆæ¯ (yes)")
            else:
                logger.info("å†³ç­–AIåˆ¤æ–­: ä¸åº”è¯¥å›å¤è¿™æ¡æ¶ˆæ¯ (no)")

            return decision

        except asyncio.TimeoutError:
            logger.warning(
                f"å†³ç­–AIè°ƒç”¨è¶…æ—¶ï¼ˆè¶…è¿‡ {timeout} ç§’ï¼‰ï¼Œé»˜è®¤ä¸å›å¤ï¼Œå¯åœ¨é…ç½®ä¸­è°ƒæ•´ decision_ai_timeout å‚æ•°"
            )
            try:
                event._decision_ai_error = True
            except Exception:
                pass
            return False
        except Exception as e:
            logger.error(f"è°ƒç”¨å†³ç­–AIæ—¶å‘ç”Ÿé”™è¯¯: {e}")
            try:
                event._decision_ai_error = True
            except Exception:
                pass
            return False

    @staticmethod
    async def call_decision_ai(
        context: Context,
        event: AstrMessageEvent,
        prompt: str,
        provider_id: str = "",
        timeout: int = 30,
        prompt_mode: str = "append",
    ) -> str:
        """
        é€šç”¨AIè°ƒç”¨æ–¹æ³•ï¼ˆä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨ï¼‰

        Args:
            context: Contextå¯¹è±¡
            event: æ¶ˆæ¯äº‹ä»¶
            prompt: æç¤ºè¯å†…å®¹
            provider_id: AIæä¾›å•†IDï¼Œç©º=é»˜è®¤
            timeout: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
            prompt_mode: æç¤ºè¯æ¨¡å¼ï¼ˆæš‚æœªä½¿ç”¨ï¼Œä¿ç•™ä»¥å…¼å®¹è°ƒç”¨ï¼‰

        Returns:
            AIçš„å›å¤æ–‡æœ¬ï¼Œå¤±è´¥è¿”å›ç©ºå­—ç¬¦ä¸²
        """
        try:
            # è·å–AIæä¾›å•†
            if provider_id:
                provider = context.get_provider_by_id(provider_id)
                if not provider:
                    logger.warning(f"æ— æ³•æ‰¾åˆ°æä¾›å•† {provider_id},ä½¿ç”¨é»˜è®¤æä¾›å•†")
                    provider = context.get_using_provider()
            else:
                provider = context.get_using_provider()

            if not provider:
                logger.error("æ— æ³•è·å–AIæä¾›å•†")
                return ""

            # ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨ persona_manager è·å–æœ€æ–°äººæ ¼é…ç½®ï¼Œæ”¯æŒå¤šä¼šè¯å’Œå®æ—¶æ›´æ–°
            try:
                # ç›´æ¥è°ƒç”¨ get_default_persona_v3() è·å–æœ€æ–°äººæ ¼é…ç½®
                # è¿™æ ·å¯ä»¥ç¡®ä¿ï¼š1. æ¯æ¬¡éƒ½è·å–æœ€æ–°é…ç½® 2. æ”¯æŒä¸åŒä¼šè¯ä½¿ç”¨ä¸åŒäººæ ¼
                default_persona = await context.persona_manager.get_default_persona_v3(
                    event.unified_msg_origin
                )

                persona_prompt = default_persona.get("prompt", "")

                # æ³¨å…¥äººæ ¼çš„å¼€åœºä¸Šä¸‹æ–‡ï¼Œä½œä¸ºcontextsä¼ é€’
                persona_contexts = []
                try:
                    begin_dialogs = default_persona.get("_begin_dialogs_processed", [])
                    if begin_dialogs:
                        persona_contexts.extend(begin_dialogs)
                except Exception as e:
                    logger.info(f"è·å–äººæ ¼ä¸Šä¸‹æ–‡å¤±è´¥: {e}")

                if DEBUG_MODE:
                    logger.info(
                        f"âœ… [é€šç”¨AIè°ƒç”¨] å·²è·å–å½“å‰äººæ ¼é…ç½®ï¼Œäººæ ¼å: {default_persona.get('name', 'default')}, é•¿åº¦: {len(persona_prompt)} å­—ç¬¦"
                    )
            except Exception as e:
                logger.warning(f"è·å–äººæ ¼è®¾å®šå¤±è´¥: {e}ï¼Œä½¿ç”¨ç©ºäººæ ¼")
                persona_prompt = ""
                persona_contexts = []

            # è°ƒç”¨AI
            async def _call_ai():
                response = await provider.text_chat(
                    prompt=prompt,
                    contexts=persona_contexts if "persona_contexts" in locals() else [],
                    image_urls=[],
                    func_tool=None,
                    system_prompt=persona_prompt,
                )
                return response.completion_text

            # ä½¿ç”¨è¶…æ—¶æ§åˆ¶
            ai_response = await asyncio.wait_for(_call_ai(), timeout=timeout)

            # ğŸ†• v1.1.2: è¿‡æ»¤AIå“åº”ä¸­çš„æ€è€ƒé“¾æ ‡è®°
            ai_response = AIResponseFilter.filter_thinking_chain(ai_response)

            return ai_response or ""

        except asyncio.TimeoutError:
            logger.warning(f"AIè°ƒç”¨è¶…æ—¶ï¼ˆè¶…è¿‡ {timeout} ç§’ï¼‰")
            return ""
        except Exception as e:
            logger.error(f"è°ƒç”¨AIæ—¶å‘ç”Ÿé”™è¯¯: {e}")
            return ""

    @staticmethod
    def _parse_decision(ai_response: str) -> bool:
        """
        è§£æAIçš„å†³ç­–å›å¤ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰

        ä¸¥æ ¼è§£æAIçš„å›å¤ï¼Œé¿å…è¯¯åˆ¤

        Args:
            ai_response: AIçš„å›å¤æ–‡æœ¬

        Returns:
            True=åº”è¯¥å›å¤ï¼ŒFalse=ä¸å›å¤
        """
        if not ai_response:
            if DEBUG_MODE:
                logger.info("AIå›å¤ä¸ºç©º,é»˜è®¤åˆ¤å®šä¸ºä¸å›å¤ï¼ˆè°¨æ…æ¨¡å¼ï¼‰")
            return False  # ç©ºå›å¤æ—¶è°¨æ…å¤„ç†

        # æ¸…ç†å›å¤æ–‡æœ¬
        cleaned_response = ai_response.strip().lower()

        # ç§»é™¤å¯èƒ½çš„æ ‡ç‚¹ç¬¦å·
        cleaned_response = cleaned_response.rstrip(".,!?ã€‚,!?")

        # ä¼˜å…ˆæ£€æŸ¥å®Œæ•´çš„yes/no
        if cleaned_response == "yes" or cleaned_response == "y":
            if DEBUG_MODE:
                logger.info(f"AIæ˜ç¡®å›å¤ '{ai_response}' (yes),åˆ¤å®šä¸ºå›å¤")
            return True

        if cleaned_response == "no" or cleaned_response == "n":
            if DEBUG_MODE:
                logger.info(f"AIæ˜ç¡®å›å¤ '{ai_response}' (no),åˆ¤å®šä¸ºä¸å›å¤")
            return False

        # æ£€æŸ¥ä¸­æ–‡çš„æ˜ç¡®å›å¤
        if (
            cleaned_response == "æ˜¯"
            or cleaned_response == "åº”è¯¥"
            or cleaned_response == "å›å¤"
        ):
            if DEBUG_MODE:
                logger.info(f"AIæ˜ç¡®å›å¤ '{ai_response}' (è‚¯å®š),åˆ¤å®šä¸ºå›å¤")
            return True

        if (
            cleaned_response == "å¦"
            or cleaned_response == "ä¸"
            or cleaned_response == "ä¸åº”è¯¥"
            or cleaned_response == "ä¸å›å¤"
        ):
            if DEBUG_MODE:
                logger.info(f"AIæ˜ç¡®å›å¤ '{ai_response}' (å¦å®š),åˆ¤å®šä¸ºä¸å›å¤")
            return False

        # å¦å®šå…³é”®è¯åˆ—è¡¨ï¼ˆæ£€æŸ¥å¼€å¤´ï¼‰
        negative_starts = ["no", "n", "å¦", "ä¸", "åˆ«", "ä¸è¦", "ä¸åº”è¯¥", "ä¸éœ€è¦"]

        # æ£€æŸ¥æ˜¯å¦ä»¥å¦å®šè¯å¼€å¤´
        for keyword in negative_starts:
            if cleaned_response.startswith(keyword):
                if DEBUG_MODE:
                    logger.info(
                        f"AIå›å¤ '{ai_response}' ä»¥å¦å®šè¯ '{keyword}' å¼€å¤´,åˆ¤å®šä¸ºä¸å›å¤"
                    )
                return False

        # è‚¯å®šå…³é”®è¯åˆ—è¡¨ï¼ˆæ£€æŸ¥å¼€å¤´ï¼‰
        positive_starts = ["yes", "y", "æ˜¯", "å¥½", "å¯ä»¥", "åº”è¯¥", "å›å¤", "è¦", "éœ€è¦"]

        # æ£€æŸ¥æ˜¯å¦ä»¥è‚¯å®šè¯å¼€å¤´
        for keyword in positive_starts:
            if cleaned_response.startswith(keyword):
                if DEBUG_MODE:
                    logger.info(
                        f"AIå›å¤ '{ai_response}' ä»¥è‚¯å®šè¯ '{keyword}' å¼€å¤´,åˆ¤å®šä¸ºå›å¤"
                    )
                return True

        # é»˜è®¤æƒ…å†µï¼šä¸æ˜ç¡®çš„å›å¤ï¼Œé‡‡ç”¨è°¨æ…ç­–ç•¥
        if DEBUG_MODE:
            logger.info(f"AIå›å¤ '{ai_response}' ä¸æ˜ç¡®,é»˜è®¤åˆ¤å®šä¸ºä¸å›å¤ï¼ˆè°¨æ…æ¨¡å¼ï¼‰")
        return False
