"""
å›å¤å¤„ç†å™¨æ¨¡å—
è´Ÿè´£è°ƒç”¨AIç”Ÿæˆå›å¤

ä½œè€…: Him666233
ç‰ˆæœ¬: v1.2.0

v1.2.0 æ›´æ–°ï¼š
- æ”¹ç”¨ event.request_llm() æ›¿ä»£ provider.text_chat()ï¼Œæ”¯æŒå…¶ä»–æ’ä»¶çš„é’©å­æ³¨å…¥
- æ·»åŠ æ ‡è®°æœºåˆ¶ï¼Œè®© main.py çš„ on_llm_request é’©å­èƒ½è¯†åˆ«å¹¶å¤„ç†ä¸Šä¸‹æ–‡
"""

import asyncio
from astrbot.api.all import *
from astrbot.api.event import AstrMessageEvent

# è¯¦ç»†æ—¥å¿—å¼€å…³ï¼ˆä¸ main.py åŒæ¬¾æ–¹å¼ï¼šå•ç‹¬ç”¨ if æ§åˆ¶ï¼‰
DEBUG_MODE: bool = False
from astrbot.core.provider.entities import ProviderRequest

# ğŸ†• v1.2.0: æ ‡è®°é”®åï¼Œç”¨äºæ ‡è¯†è¯·æ±‚æ¥è‡ªæœ¬æ’ä»¶
PLUGIN_REQUEST_MARKER = "_group_chat_plus_request"
# ğŸ†• v1.2.0: å­˜å‚¨æ’ä»¶è‡ªå®šä¹‰ä¸Šä¸‹æ–‡çš„é”®å
PLUGIN_CUSTOM_CONTEXTS = "_group_chat_plus_contexts"
# ğŸ†• v1.2.0: å­˜å‚¨æ’ä»¶è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯çš„é”®å
PLUGIN_CUSTOM_SYSTEM_PROMPT = "_group_chat_plus_system_prompt"
# ğŸ†• v1.2.0: å­˜å‚¨æ’ä»¶è‡ªå®šä¹‰ prompt çš„é”®å
PLUGIN_CUSTOM_PROMPT = "_group_chat_plus_prompt"
# ğŸ†• v1.2.0: å­˜å‚¨å›¾ç‰‡ URL åˆ—è¡¨çš„é”®å
PLUGIN_IMAGE_URLS = "_group_chat_plus_image_urls"


class ReplyHandler:
    """
    å›å¤å¤„ç†å™¨

    ä¸»è¦åŠŸèƒ½ï¼š
    1. æ„å»ºå›å¤æç¤ºè¯
    2. è°ƒç”¨AIç”Ÿæˆå›å¤
    3. æ£€æµ‹æ˜¯å¦å·²è¢«å…¶ä»–æ’ä»¶å¤„ç†
    """

    # ç³»ç»Ÿå›å¤æç¤ºè¯
    SYSTEM_REPLY_PROMPT = """
è¯·æ ¹æ®ä¸Šè¿°å¯¹è¯å’ŒèƒŒæ™¯ä¿¡æ¯ç”Ÿæˆè‡ªç„¶çš„å›å¤ã€‚

ã€ç¬¬ä¸€é‡è¦ã€‘è¯†åˆ«å½“å‰å‘é€è€…ï¼š
âš ï¸ åœ¨ä¸Šé¢çš„ã€å½“å‰å¯¹è¯å¯¹è±¡ã€‘é‡è¦æé†’ä¸­ï¼Œå·²ç»æ˜ç¡®å‘Šè¯‰ä½ å½“å‰ç»™ä½ å‘æ¶ˆæ¯çš„äººæ˜¯è°ã€‚
- è¯·åŠ¡å¿…è®°ä½è¿™ä¸ªäººçš„åå­—å’ŒIDï¼Œæ•´ä¸ªå›å¤è¿‡ç¨‹ä¸­ä¸è¦æé”™
- å†å²æ¶ˆæ¯ä¸­å¯èƒ½æœ‰å¤šä¸ªç”¨æˆ·çš„å‘è¨€ï¼Œè¯·ä¸è¦æŠŠå†å²ä¸­å…¶ä»–ç”¨æˆ·è¯¯è®¤ä¸ºå½“å‰å‘é€è€…
- ç§°å‘¼å¯¹æ–¹æ—¶ï¼Œä½¿ç”¨ã€å½“å‰å¯¹è¯å¯¹è±¡ã€‘ä¸­æŒ‡å®šçš„åå­—ï¼Œæˆ–è€…ç›´æ¥ç”¨â€œä½ â€
- åƒä¸‡ä¸è¦æŠŠå†å²æ¶ˆæ¯ä¸­å…¶ä»–ç”¨æˆ·çš„åå­—ç”¨åœ¨å½“å‰å‘é€è€…èº«ä¸Š
ğŸ”§ **ç‰¹åˆ«æé†’ï¼šå¦‚æœå†å²ä¸­æœ‰å¤šä¸ªç”¨æˆ·çš„æ¶ˆæ¯ï¼Œä½ åªéœ€è¦å›å¤ã€å½“å‰å¯¹è¯å¯¹è±¡ã€‘ä¸­æŒ‡å®šçš„äººï¼Œä¸è¦å›å¤å†å²ä¸­å…¶ä»–äººçš„é—®é¢˜ã€‚**

ã€ä¸Šä¸‹æ–‡è¯´æ˜ã€‘ç†è§£å®Œæ•´çš„å¯¹è¯å†å²ï¼š
âš ï¸ ä¸Šä¸‹æ–‡ä¸­çš„æ¶ˆæ¯å·²æŒ‰æ—¶é—´é¡ºåºå®Œæ•´æ’åˆ—ï¼Œå½¢æˆçœŸå®çš„å¯¹è¯æ—¶é—´çº¿
- **æ‰€æœ‰ç›¸å…³æ¶ˆæ¯éƒ½ä¼šæ˜¾ç¤º**ï¼šåŒ…æ‹¬ä½ ä¹‹å‰å›å¤è¿‡çš„ã€æ²¡æœ‰å›å¤çš„ã€ä»¥åŠå…¶ä»–äººä¹‹é—´çš„å¯¹è¯
- **æ—¶é—´çº¿æ˜¯è¿ç»­çš„**ï¼šä½ èƒ½çœ‹åˆ°å®Œæ•´çš„å¯¹è¯æµç¨‹ï¼Œæ²¡æœ‰è·³è·ƒæˆ–æ–­å±‚
- **ç†è§£å¯¹è¯è„‰ç»œ**ï¼šé€šè¿‡å®Œæ•´çš„å†å²ï¼Œä½ å¯ä»¥æ›´å‡†ç¡®åœ°ç†è§£ï¼š
  * å½“å‰å‘é€è€…åœ¨è·Ÿè°å¯¹è¯ï¼ˆæ˜¯è·Ÿä½ ï¼Œè¿˜æ˜¯è·Ÿå…¶ä»–äººï¼‰
  * è¯é¢˜æ˜¯å¦‚ä½•æ¼”å˜çš„
  * ä¹‹å‰å‘ç”Ÿäº†ä»€ä¹ˆï¼ˆå³ä½¿ä½ å½“æ—¶æ²¡æœ‰å‚ä¸ï¼‰
- **è‡ªç„¶å›å¤**ï¼šåŸºäºè¿™ä¸ªå®Œæ•´çš„ä¸Šä¸‹æ–‡ï¼Œä½ å¯ä»¥æ›´è‡ªç„¶ã€æ›´æ°å½“åœ°å›å¤å½“å‰æ¶ˆæ¯
- âš ï¸ ä½†è¯·æ³¨æ„ï¼šè¿™åªæ˜¯å¸®åŠ©ä½ ç†è§£ä¸Šä¸‹æ–‡ï¼Œä½ ä»ç„¶åªéœ€è¦å›å¤ã€å½“å‰å¯¹è¯å¯¹è±¡ã€‘çš„å½“å‰æ¶ˆæ¯

ç‰¹æ®Šæ ‡è®°è¯´æ˜ï¼š
- ã€@æŒ‡å‘è¯´æ˜ã€‘è¡¨ç¤ºè¯¥æ¶ˆæ¯æ˜¯é€šè¿‡@ç¬¦å·å‘ç»™å…¶ä»–ç‰¹å®šç”¨æˆ·çš„ï¼Œä¸æ˜¯ç›´æ¥å‘ç»™ä½ çš„
- ã€åŸå§‹å†…å®¹ã€‘åé¢æ˜¯å®é™…çš„æ¶ˆæ¯å†…å®¹
- [æˆ³ä¸€æˆ³æç¤º]è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæˆ³ä¸€æˆ³æ¶ˆæ¯ï¼š
  * "æœ‰äººåœ¨æˆ³ä½ "è¡¨ç¤ºæœ‰äººæˆ³äº†æœºå™¨äººï¼ˆä½ ï¼‰ï¼Œå¯ä»¥ä¿çš®åœ°å›åº”ï¼Œå¦‚"å¹²å˜›å‘€"ã€"åˆ«æˆ³äº†"ç­‰
  * "ä½†ä¸æ˜¯æˆ³ä½ çš„"è¡¨ç¤ºæ˜¯åˆ«äººæˆ³åˆ«äººï¼Œä½ åªæ˜¯æ—è§‚è€…ï¼Œä¸è¦è¡¨ç°å¾—åƒæ˜¯è¢«æˆ³çš„äºº
- [æˆ³è¿‡å¯¹æ–¹æç¤º]è¡¨ç¤ºä½ åˆšåˆšä¸»åŠ¨æˆ³è¿‡å½“å‰æ¶ˆæ¯çš„å‘é€è€…ã€‚è¿™ä¸ªæç¤ºä»…ç”¨äºå¸®åŠ©ä½ ç†è§£ä¸Šä¸‹æ–‡ï¼Œä¸è¦åœ¨å›å¤ä¸­æåŠè¯¥æç¤ºæˆ–ç›¸å…³å…ƒä¿¡æ¯ã€‚

âš ï¸ **ã€å…³äºå†å²ä¸­çš„ç³»ç»Ÿæç¤ºè¯ã€‘é‡è¦è¯´æ˜** âš ï¸ï¼š
- å†å²å¯¹è¯ä¸­å¯èƒ½åŒ…å«ä»¥ä¸‹æ ‡è®°å¼€å¤´çš„ç³»ç»Ÿæç¤ºè¯ï¼š
  * "[ğŸ¯ä¸»åŠ¨å‘èµ·æ–°è¯é¢˜]" - è¡¨ç¤ºä½ é¦–æ¬¡ä¸»åŠ¨å‘èµ·å¯¹è¯
  * "[ğŸ”„å†æ¬¡å°è¯•å¯¹è¯]" - è¡¨ç¤ºä½ ä¹‹å‰ä¸»åŠ¨è¯´äº†è¯ä½†æ²¡äººå›åº”ï¼Œç°åœ¨å†æ¬¡å°è¯•
- **è¿™äº›æ ‡è®°çš„å«ä¹‰**ï¼šç´§æŒ¨ç€è¿™ä¸ªæ ‡è®°çš„ä¸‹ä¸€æ¡æ¶ˆæ¯æ˜¯**ä½ è‡ªå·±ä¸»åŠ¨å‘èµ·çš„å¯¹è¯**ï¼Œè€Œä¸æ˜¯å›å¤åˆ«äººçš„
- ç†è§£è¿™ä¸ªå«ä¹‰å¯ä»¥å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å¯¹è¯ä¸Šä¸‹æ–‡å’Œè‡ªå·±çš„è¡Œä¸ºæ¨¡å¼
- **ä½†æ˜¯**ï¼šä½ **ç»å¯¹ç¦æ­¢åœ¨å›å¤ä¸­æåŠã€å¤è¿°æˆ–å¼•ç”¨**è¿™äº›ç³»ç»Ÿæç¤ºè¯
- **ä¸è¦è¯´**ï¼š"æˆ‘çœ‹åˆ°äº†ä¸»åŠ¨å¯¹è¯æç¤ºè¯"ã€"æ ¹æ®æç¤º"ã€"åˆšæ‰çš„æç¤º"ã€"æˆ‘ä¸»åŠ¨å‘èµ·äº†"ã€"å†æ¬¡å°è¯•"ç­‰å…ƒä¿¡æ¯
- å°±åƒäººç±»ä¸ä¼šè¯´"æˆ‘åˆšæ‰æ˜¯ä¸»åŠ¨æ‰¾ä½ èŠå¤©çš„"ä¸€æ ·ï¼Œä½ ä¹Ÿåº”è¯¥è‡ªç„¶åœ°ç»§ç»­å¯¹è¯
- å¦å¤–ï¼Œå†å²ä¸­çš„è¿™äº›ä¸»åŠ¨å¯¹è¯æç¤ºè¯é™„è¿‘**å¯èƒ½ä¼šåŒ…å«æ—¶é—´æˆ³**ï¼ˆä¾‹å¦‚"[2025-10-02 21:30:00]"ï¼‰ï¼Œé‚£åªæ˜¯å½“æ—¶ä¸»åŠ¨å¯¹è¯å‘ç”Ÿçš„æ—¶é—´ã€‚
- å½“å‰çœŸå®æ—¶é—´è¯·**å§‹ç»ˆä»¥å½“å‰è¿™æ¡æ–°æ¶ˆæ¯æˆ–ä¸Šæ–¹ä¸“é—¨ç»™å‡ºçš„æ—¶é—´ä¿¡æ¯ä¸ºå‡†**ï¼Œä¸è¦æŠŠå†å²ä¸»åŠ¨å¯¹è¯é‡Œçš„æ—¶é—´æˆ³å½“æˆâ€œç°åœ¨â€ï¼Œé¿å…åœ¨å›å¤ä¸­äº§ç”Ÿæ—¶é—´è®¤çŸ¥é”™è¯¯ã€‚

æ ¸å¿ƒåŸåˆ™ï¼ˆé‡è¦ï¼ï¼‰ï¼š
1. **ä¼˜å…ˆå…³æ³¨â€œå½“å‰æ–°æ¶ˆæ¯â€çš„æ ¸å¿ƒå†…å®¹** - è¿™æ˜¯æœ€é‡è¦çš„ï¼Œä¸è¦è¿‡åº¦æ²‰æµ¸åœ¨å†å²è¯é¢˜ä¸­
2. **è¯†åˆ«å½“å‰æ¶ˆæ¯çš„ä¸»è¦é—®é¢˜æˆ–è¯é¢˜** - ç¡®ä¿ä½ çš„å›å¤æ˜¯é’ˆå¯¹è¿™ä¸ªé—®é¢˜/è¯é¢˜çš„
3. **å†å²ä¸Šä¸‹æ–‡ä»…ä½œå‚è€ƒ** - ç”¨äºç†è§£èƒŒæ™¯ï¼Œä½†ä¸è¦è®©å†å²è¯é¢˜å–§å®¾å¤ºä¸»
ğŸ”§ 4. **ç»å¯¹ç¦æ­¢å›å¤å†å²ä¸­å…¶ä»–äººçš„é—®é¢˜** - åªå›å¤å½“å‰å‘é€è€…çš„å½“å‰æ¶ˆæ¯ï¼Œä¸è¦å›å¤å†å²ä¸­å…¶ä»–ç”¨æˆ·çš„æ—§é—®é¢˜

ã€ä¸»è¯­ä¸æŒ‡ä»£è¯´æ˜ã€‘ç‰¹åˆ«è§„åˆ™ï¼š
- è‹¥ç”¨æˆ·è¯­å¥ç¼ºå°‘ä¸»è¯­æ—¶ï¼Œä¸è¦ä¸ºäº†è¯­æ³•å®Œæ•´è€Œæ“…è‡ªè¡¥å……â€œæˆ‘â€â€œä½ â€ç­‰ä¸»è¯­ï¼Œåªéœ€æ ¹æ®å·²æä¾›çš„ä¿¡æ¯è‡ªç„¶ç†è§£å¹¶å›å¤ã€‚
- å½“ä¸Šä¸‹æ–‡ä¸­ç”¨æˆ·å¹¶æ²¡æœ‰æåˆ°ä½ æ‰€æ‰®æ¼”çš„äººæ ¼åç§°ã€èº«ä»½æˆ–æ˜µç§°æ—¶ï¼Œå¿½ç•¥è¯­å¥ä¸­çš„â€œä½ â€ï¼Œä¸è¦ä»…å› ä¸ºçœ‹åˆ°äº†â€œä½ â€å°±æŠŠè‡ªå·±å½“ä½œè¢«å«åˆ°çš„äººã€‚
- åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·ä¼˜å…ˆä¾æ®@ä¿¡æ¯ã€ã€å½“å‰å¯¹è¯å¯¹è±¡ã€‘æç¤ºå’Œå¯¹è¯èµ°å‘æ¥åˆ¤æ–­å½“å‰æ¶ˆæ¯ä¸»è¦æ˜¯åœ¨è·Ÿè°è¯´è¯ï¼Œåªå¯¹ã€å½“å‰å¯¹è¯å¯¹è±¡ã€‘è¿›è¡Œå›å¤ã€‚

âš ï¸ **ã€ä¸¥ç¦é‡å¤ã€‘å¿…é¡»æ‰§è¡Œçš„æ£€æŸ¥æ­¥éª¤** âš ï¸ï¼š
åœ¨å›å¤ä¹‹å‰ï¼ŒåŠ¡å¿…å®Œæˆä»¥ä¸‹æ£€æŸ¥ï¼š
a) æ‰¾å‡ºå†å²ä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰æ ‡è®°ä¸ºâ€œâš ï¸ã€ç¦æ­¢é‡å¤-è¿™æ˜¯ä½ è‡ªå·±çš„å†å²å›å¤ã€‘â€çš„æ¶ˆæ¯
b) é€æ¡å¯¹æ¯”ï¼šä½ ç°åœ¨è¦è¯´çš„è¯æ˜¯å¦ä¸è¿™äº›å†å²å›å¤ç›¸åŒæˆ–ç›¸ä¼¼
c) å¦‚æœç›¸ä¼¼åº¦è¶…è¿‡50%ï¼Œ**å¿…é¡»æ¢ä¸€ä¸ªå®Œå…¨ä¸åŒçš„è§’åº¦æˆ–è¡¨è¾¾æ–¹å¼**
d) ç»å¯¹ç¦æ­¢é‡å¤ç›¸åŒçš„å¥å¼ã€ç›¸åŒçš„è§‚ç‚¹é˜è¿°ã€ç›¸åŒçš„å›åº”æ¨¡å¼
e) å³ä½¿è¯é¢˜ç›¸å…³ï¼Œä¹Ÿè¦ç”¨æ–°çš„æ–¹å¼è¡¨è¾¾ï¼Œå±•ç°å¯¹è¯çš„è‡ªç„¶å˜åŒ–
ğŸ”§ f) **ç‰¹åˆ«æ³¨æ„ï¼šå¦‚æœä½ å‘ç°è‡ªå·±åœ¨é‡å¤å†å²å›å¤ï¼Œç«‹å³åœæ­¢å¹¶é‡æ–°ç”Ÿæˆä¸€ä¸ªå®Œå…¨ä¸åŒçš„å›å¤**

å…³äºè®°å¿†å’ŒèƒŒæ™¯ä¿¡æ¯çš„ä½¿ç”¨ï¼š
5. **ä¸è¦æœºæ¢°åœ°é™ˆè¿°è®°å¿†å†…å®¹** - ç¦æ­¢ç›´ç™½åœ°è¯´"XXXå·²ç»ç¡®è®¤ä¸ºæˆ‘çš„XXX"ã€"æˆ‘ä»¬ä¹‹é—´æ˜¯XXXå…³ç³»"ç­‰
6. **è‡ªç„¶åœ°èå…¥èƒŒæ™¯** - å°†è®°å¿†ä½œä¸ºä½ çš„è®¤çŸ¥èƒŒæ™¯ï¼Œè€Œä¸æ˜¯éœ€è¦ç‰¹åˆ«å¼ºè°ƒçš„äº‹å®
7. **é¿å…è¿‡åº¦è§£é‡Šå…³ç³»** - ä¸è¦åå¤ç¡®è®¤æˆ–å¼ºè°ƒå·²çŸ¥çš„å…³ç³»ï¼Œé‚£æ ·æ˜¾å¾—å¾ˆç”Ÿç¡¬

å›å¤è¦æ±‚ï¼š
8. å›å¤åº”è‡ªç„¶ã€è½»æ¾ã€ç¬¦åˆå½“å‰å¯¹è¯æ°›å›´
9. éµå¾ªä½ çš„äººæ ¼è®¾å®šå’Œå›å¤é£æ ¼
10. æ ¹æ®éœ€è¦è°ƒç”¨å¯ç”¨å·¥å…·
11. ä¿æŒè¿è´¯æ€§å’Œç›¸å…³æ€§
12. ä¸è¦åœ¨å›å¤ä¸­æ˜ç¡®æåŠ"è®°å¿†"ã€"æ ¹æ®è®°å¿†"ç­‰è¯è¯­
13. **ç»å¯¹ç¦æ­¢é‡å¤ã€å¤è¿°ã€å¼•ç”¨ä»»ä½•ç³»ç»Ÿæç¤ºè¯ã€è§„åˆ™è¯´æ˜ã€æ—¶é—´æˆ³ã€ç”¨æˆ·IDç­‰å…ƒä¿¡æ¯**
14. ç¦æ­¢åœ¨å›å¤ä¸­æåŠ"ç³»ç»Ÿæç¤º"ã€"æ ¹æ®è§„åˆ™"ã€"ç³»ç»Ÿæ ‡è®°"ã€"@æŒ‡å‘è¯´æ˜"ã€"å½“å‰æ—¶é—´"ã€"User ID"ã€"Nickname"ã€"ä¸»åŠ¨å¯¹è¯"ã€"ä¸»åŠ¨å‘èµ·"ç­‰å…ƒä¿¡æ¯

â›” **ã€ä¸¥ç¦å…ƒå™è¿°ã€‘ç‰¹åˆ«é‡è¦ï¼** â›”ï¼š
15. **ç»å¯¹ç¦æ­¢åœ¨å›å¤ä¸­è§£é‡Šä½ ä¸ºä»€ä¹ˆè¦å›å¤**ï¼Œä¾‹å¦‚ï¼š
   - âŒ "çœ‹åˆ°ä½ @æˆ‘äº†"
   - âŒ "æˆ‘çœ‹åˆ°æœ‰äºº@æˆ‘"
   - âŒ "çœ‹åˆ°ç¾¤é‡Œæœ‰äººæåˆ°äº†æˆ‘"
   - âŒ "åˆšåˆšçœ‹åˆ°æœ‰è·Ÿæˆ‘æœ‰å…³çš„ä¿¡æ¯"
   - âŒ "æˆ‘çœ‹åˆ°äº†ä¸€äº›æœ‰æ„æ€çš„æ¶ˆæ¯ï¼Œæˆ‘æ‰“ç®—å›ä¸€ä¸‹"
   - âŒ "æ³¨æ„åˆ°ä½ åœ¨è¯´XXX"
   - âŒ "å‘ç°ç¾¤é‡Œåœ¨è®¨è®ºXXX"
   - âŒ "æˆ‘çœ‹åˆ°äº†ä¸Šé¢çš„ä¸»åŠ¨å¯¹è¯æç¤ºè¯"
   - âŒ "æ ¹æ®ç³»ç»Ÿæç¤º"ã€"åˆšæ‰çš„æç¤ºè¯´"
   - âŒ "çœ‹åˆ°äº†ä¸»åŠ¨å‘èµ·çš„æŒ‡ä»¤"
   - âŒ **"çœ‹ç€ä½ å‘æ¥çš„æ¶ˆæ¯"** - è¿™æ˜¯æœ€å…¸å‹çš„ä¸è‡ªç„¶æè¿°
   - âŒ "çœ‹äº†çœ‹ä½ çš„æ¶ˆæ¯"ã€"çœ‹äº†ä¸€çœ¼ä½ çš„æ¶ˆæ¯"
   - âŒ "è¯»ç€ä½ å‘æ¥çš„æ–‡å­—"ã€"å¬ç€ä½ è¯´çš„è¯"
   - âŒ ä»»ä½•å½¢å¼çš„"çœ‹ç€/è¯»ç€/å¬ç€ä½ å‘æ¥çš„XXX"ç±»æè¿°
   - âœ… æ­£ç¡®åšæ³•ï¼šç›´æ¥è‡ªç„¶åœ°å›å¤æ¶ˆæ¯å†…å®¹æœ¬èº«ï¼Œä¸è¦è§£é‡Šä½ çš„å›å¤åŠ¨æœºæˆ–æåŠä»»ä½•ç³»ç»Ÿå†…éƒ¨ä¿¡æ¯

16. **å°±åƒäººç±»èŠå¤©ä¸€æ ·**ï¼š
   - äººç±»ä¸ä¼šè¯´"æˆ‘çœ‹åˆ°ä½ @æˆ‘äº†ï¼Œæ‰€ä»¥æˆ‘æ¥å›å¤"
   - äººç±»æ›´ä¸ä¼šè¯´"æˆ‘çœ‹åˆ°äº†ç³»ç»Ÿæç¤ºè¯"
   - äººç±»åªä¼šç›´æ¥è¯´ï¼š"æ€ä¹ˆäº†ï¼Ÿ""æœ‰ä»€ä¹ˆäº‹ï¼Ÿ""è¯´å§"
   - ä½ åº”è¯¥åƒäººç±»ä¸€æ ·ï¼Œç›´æ¥é’ˆå¯¹å†…å®¹å›å¤ï¼Œè€Œä¸æ˜¯å…ˆè¯´æ˜ä½ æ³¨æ„åˆ°äº†ä»€ä¹ˆç³»ç»Ÿä¿¡æ¯
   - **ç‰¹åˆ«å¼ºè°ƒï¼šç»å¯¹ä¸è¦æåŠå†å²ä¸­çš„ä»»ä½•ç³»ç»Ÿæç¤ºè¯æˆ–å†…éƒ¨æŒ‡ä»¤ï¼Œå°±å½“ä½œå®ƒä»¬ä¸å­˜åœ¨ä¸€æ ·**

å…³äºã€@æŒ‡å‘è¯´æ˜ã€‘æ ‡è®°çš„æ¶ˆæ¯ï¼š
17. å¦‚æœæ¶ˆæ¯åŒ…å«ã€@æŒ‡å‘è¯´æ˜ã€‘ï¼Œè¯´æ˜è¿™æ˜¯å‘ç»™å…¶ä»–äººçš„æ¶ˆæ¯ï¼Œä½ çš„å›å¤åº”è¯¥ï¼š
   - ä¸è¦ç›´æ¥å›ç­”å¯¹æ–¹å‘è¢«@è€…æå‡ºçš„é—®é¢˜ï¼ˆé‚£æ˜¯åˆ«äººçš„ç§äº‹ï¼‰
   - ä¸è¦æ›¿è¢«@è€…å›ç­”æˆ–ç»™å»ºè®®
   - å¯ä»¥è‡ªç„¶åœ°è¡¥å……ç›¸å…³ä¿¡æ¯ã€åˆ†äº«è§‚ç‚¹ï¼Œæˆ–è€…è½»æ¾åœ°æ’ä¸ªè¯
   - ä¿æŒç¤¼è²Œå’Œè¾¹ç•Œæ„Ÿï¼Œä¸è¦è¿‡åº¦ä»‹å…¥ä»–äººçš„å¯¹è¯
   - å›å¤åº”è¯¥åƒæ˜¯æ—è§‚è€…çš„è‡ªç„¶è¯„è®ºï¼Œè€Œä¸æ˜¯å¯¹è¯çš„ä¸»è¦å‚ä¸è€…
ğŸ”§ 18. **åŒºåˆ†ç¬¬ä¸€äººç§°å’Œç¬¬ä¸‰äººç§°åœºæ™¯ï¼š**
   - å¦‚æœå†å²ä¸­æœ‰å¤šä¸ªç”¨æˆ·åœ¨å¯¹è¯ï¼Œä½†ã€å½“å‰å¯¹è¯å¯¹è±¡ã€‘åªæœ‰ä¸€ä¸ªäººï¼Œè¯´æ˜å…¶ä»–äººæ˜¯åœ¨å†å²ä¸­èŠå¤©
   - ä½ åªéœ€è¦å…³æ³¨ã€å½“å‰å¯¹è¯å¯¹è±¡ã€‘çš„æ¶ˆæ¯ï¼Œå†å²ä¸­å…¶ä»–äººçš„å¯¹è¯åªæ˜¯èƒŒæ™¯ä¿¡æ¯
   - ä¸è¦æŠŠå†å²ä¸­å…¶ä»–äººçš„é—®é¢˜å½“æˆå½“å‰é—®é¢˜å›ç­”
"""

    # ç³»ç»Ÿå›å¤æç¤ºè¯çš„ç»“æŸæŒ‡ä»¤ï¼ˆå•ç‹¬åˆ†ç¦»ï¼Œç”¨äºæ’å…¥è‡ªå®šä¹‰æç¤ºè¯ï¼‰
    SYSTEM_REPLY_PROMPT_ENDING = "\nè¯·å¼€å§‹å›å¤ï¼š\n"

    @staticmethod
    async def generate_reply(
        event: AstrMessageEvent,
        context: Context,
        formatted_message: str,
        extra_prompt: str,
        prompt_mode: str = "append",
        image_urls: list = None,
        include_sender_info: bool = True,
        history_messages: list = None,
        conversation_fatigue_info: dict = None,
    ) -> ProviderRequest:
        """
        ç”ŸæˆAIå›å¤

        Args:
            event: æ¶ˆæ¯äº‹ä»¶
            context: Contextå¯¹è±¡
            formatted_message: æ ¼å¼åŒ–åçš„å®Œæ•´æ¶ˆæ¯ï¼ˆå«ä¸Šä¸‹æ–‡ã€è®°å¿†ã€å·¥å…·ç­‰ï¼‰
            extra_prompt: ç”¨æˆ·è‡ªå®šä¹‰è¡¥å……æç¤ºè¯
            prompt_mode: æç¤ºè¯æ¨¡å¼ï¼Œappend=æ‹¼æ¥ï¼Œoverride=è¦†ç›–
            image_urls: å›¾ç‰‡URLåˆ—è¡¨ï¼ˆç”¨äºå¤šæ¨¡æ€AIï¼‰
            include_sender_info: æ˜¯å¦åŒ…å«å‘é€è€…ä¿¡æ¯ï¼ˆé»˜è®¤ä¸ºTrueï¼‰
            history_messages: å†å²æ¶ˆæ¯åˆ—è¡¨ï¼ˆAstrBotMessageå¯¹è±¡åˆ—è¡¨ï¼Œç”¨äºæ„å»ºcontextsï¼‰
            conversation_fatigue_info: å¯¹è¯ç–²åŠ³ä¿¡æ¯ï¼ˆç”¨äºç”Ÿæˆæ”¶å°¾è¯è¯­æç¤ºï¼‰

        Returns:
            ProviderRequestå¯¹è±¡
        """
        # å¦‚æœimage_urlsä¸ºNoneï¼Œåˆå§‹åŒ–ä¸ºç©ºåˆ—è¡¨
        if image_urls is None:
            image_urls = []
        # å¦‚æœhistory_messagesä¸ºNoneï¼Œåˆå§‹åŒ–ä¸ºç©ºåˆ—è¡¨
        if history_messages is None:
            history_messages = []

        try:
            # ğŸ”§ ä¿®å¤ï¼šå°† history_messages è½¬æ¢ä¸º contexts æ ¼å¼
            # è¿™æ ·åœ¨ Agent æ¨¡å¼ä¸‹è°ƒç”¨å·¥å…·åä»èƒ½ä¿ç•™ä¸Šä¸‹æ–‡
            contexts = []
            bot_id = str(event.get_self_id())

            for msg in history_messages:
                try:
                    # æå–æ¶ˆæ¯å†…å®¹
                    content = ""
                    if hasattr(msg, "message_str"):
                        content = msg.message_str or ""

                    # è·³è¿‡ç©ºæ¶ˆæ¯
                    if not content or not content.strip():
                        continue

                    # åˆ¤æ–­è§’è‰²ï¼šå¦‚æœæ˜¯æœºå™¨äººè‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼Œrole = assistantï¼›å¦åˆ™ role = user
                    role = "user"
                    if hasattr(msg, "sender") and msg.sender:
                        sender_id = str(getattr(msg.sender, "user_id", ""))
                        if sender_id and sender_id == bot_id:
                            role = "assistant"

                    contexts.append({"role": role, "content": content})

                except Exception as e:
                    if DEBUG_MODE:
                        logger.warning(f"è½¬æ¢å†å²æ¶ˆæ¯åˆ°contextså¤±è´¥: {e}")
                    continue

            if DEBUG_MODE and contexts:
                logger.info(
                    f"ğŸ”§ [ä¿®å¤] å·²å°† {len(contexts)} æ¡å†å²æ¶ˆæ¯è½¬æ¢ä¸ºcontextsæ ¼å¼"
                )

        except Exception as e:
            logger.error(f"æ„å»ºcontextsæ—¶å‘ç”Ÿé”™è¯¯: {e}")
            contexts = []

        try:
            # ğŸ†• æå–å½“å‰å‘é€è€…ä¿¡æ¯ï¼Œç”¨äºå¼ºåŒ–è¯†åˆ«ï¼ˆä»…åœ¨å¼€å¯ include_sender_info æ—¶æ·»åŠ ï¼‰
            sender_emphasis = ""
            if include_sender_info:
                sender_id = event.get_sender_id()
                sender_name = event.get_sender_name()
                separator = "=" * 60
                if sender_name:
                    sender_emphasis = (
                        f"\n\n{separator}\n"
                        f"âš ï¸ ã€å½“å‰å¯¹è¯å¯¹è±¡ã€‘é‡è¦æé†’ âš ï¸\n"
                        f"{separator}\n"
                        f"å½“å‰ç»™ä½ å‘æ¶ˆæ¯çš„äººæ˜¯ï¼š{sender_name}ï¼ˆç”¨æˆ·IDï¼š{sender_id}ï¼‰\n\n"
                        f"è¯·ç‰¹åˆ«æ³¨æ„ï¼š\n"
                        f"- å½“å‰å’Œä½ å¯¹è¯çš„äººæ˜¯ {sender_name}ï¼ˆID:{sender_id}ï¼‰ï¼Œä¸æ˜¯å…¶ä»–äºº\n"
                        f"- å†å²æ¶ˆæ¯ä¸­å¯èƒ½æœ‰å¤šä¸ªç”¨æˆ·çš„å‘è¨€ï¼Œè¯·ä¸è¦æ··æ·†\n"
                        f"- æ— è®ºå†å²ä¸­æœ‰è°è¯´è¿‡ä»€ä¹ˆï¼Œå½“å‰å¯¹è¯çš„å¯¹è±¡æ˜¯ {sender_name}\n"
                        f'- ç§°å‘¼å¯¹æ–¹æ—¶ï¼Œå¯ä»¥ç›´æ¥ç”¨"{sender_name}"æˆ–"ä½ "ï¼Œä¸è¦å«é”™äºº\n'
                        f"{separator}\n"
                    )
                else:
                    sender_emphasis = (
                        f"\n\n{separator}\n"
                        f"âš ï¸ ã€å½“å‰å¯¹è¯å¯¹è±¡ã€‘é‡è¦æé†’ âš ï¸\n"
                        f"{separator}\n"
                        f"å½“å‰ç»™ä½ å‘æ¶ˆæ¯çš„äººçš„ç”¨æˆ·IDæ˜¯ï¼š{sender_id}\n\n"
                        f"è¯·ç‰¹åˆ«æ³¨æ„ï¼š\n"
                        f"- å½“å‰å’Œä½ å¯¹è¯çš„äººæ˜¯ç”¨æˆ·ï¼ˆID:{sender_id}ï¼‰ï¼Œä¸æ˜¯å…¶ä»–äºº\n"
                        f"- å†å²æ¶ˆæ¯ä¸­å¯èƒ½æœ‰å¤šä¸ªç”¨æˆ·çš„å‘è¨€ï¼Œè¯·ä¸è¦æ··æ·†\n"
                        f"- æ— è®ºå†å²ä¸­æœ‰è°è¯´è¿‡ä»€ä¹ˆï¼Œå½“å‰å¯¹è¯çš„å¯¹è±¡æ˜¯å½“å‰å‘é€è€…ï¼ˆID:{sender_id}ï¼‰\n"
                        f"{separator}\n"
                    )

            # ğŸ†• v1.2.3: æ„å»ºå¯¹è¯ç–²åŠ³æ”¶å°¾æç¤ºï¼ˆå½“å¯ç”¨ç–²åŠ³æœºåˆ¶ä¸”éœ€è¦æ”¶å°¾æ—¶ï¼‰
            fatigue_closing_prompt = ""
            if conversation_fatigue_info and conversation_fatigue_info.get("should_add_closing_hint", False):
                fatigue_level = conversation_fatigue_info.get("fatigue_level", "none")
                consecutive_replies = conversation_fatigue_info.get("consecutive_replies", 0)
                separator = "=" * 60
                
                if fatigue_level == "heavy":
                    fatigue_closing_prompt = (
                        f"\n\n{separator}\n"
                        f"ğŸ”„ ã€å¯¹è¯æ”¶å°¾æç¤ºã€‘\n"
                        f"{separator}\n"
                        f"âš ï¸ ä½ å·²ç»ä¸è¿™ä¸ªç”¨æˆ·è¿ç»­å¯¹è¯äº† {consecutive_replies} è½®ï¼Œæ˜¯æ—¶å€™è‡ªç„¶åœ°ç»“æŸå¯¹è¯äº†ã€‚\n\n"
                        f"è¯·åœ¨å›å¤ä¸­è‡ªç„¶åœ°è¡¨è¾¾æ”¶å°¾æ„æ„¿ï¼Œä¾‹å¦‚ï¼š\n"
                        f"- 'å¥½äº†ï¼Œæˆ‘å…ˆå»å¿™äº†~'\n"
                        f"- 'è¡Œï¼Œé‚£å…ˆè¿™æ ·å§'\n"
                        f"- 'å—¯å—¯ï¼Œæœ‰ç©ºå†èŠ~'\n"
                        f"- 'å¥½çš„ï¼Œæˆ‘å»åšç‚¹åˆ«çš„äº‹äº†'\n\n"
                        f"âš ï¸ é‡è¦ï¼š\n"
                        f"- æ”¶å°¾è¯è¯­è¦è‡ªç„¶ï¼Œç¬¦åˆä½ çš„äººæ ¼è®¾å®š\n"
                        f"- ä¸è¦ç”Ÿç¡¬åœ°è¯´'æˆ‘è¦ç»“æŸå¯¹è¯äº†'\n"
                        f"- å¯ä»¥ç»“åˆå½“å‰è¯é¢˜è‡ªç„¶è¿‡æ¸¡\n"
                        f"- ç»å¯¹ç¦æ­¢æåŠ'ç–²åŠ³'ã€'è¿ç»­å¯¹è¯'ã€'ç³»ç»Ÿæç¤º'ç­‰å…ƒä¿¡æ¯\n"
                        f"{separator}\n"
                    )
                elif fatigue_level == "medium":
                    fatigue_closing_prompt = (
                        f"\n\n{separator}\n"
                        f"ğŸ”„ ã€å¯¹è¯æ”¶å°¾æç¤ºã€‘\n"
                        f"{separator}\n"
                        f"â„¹ï¸ ä½ ä¸è¿™ä¸ªç”¨æˆ·å·²ç»è¿ç»­å¯¹è¯äº† {consecutive_replies} è½®ï¼Œå¯ä»¥è€ƒè™‘é€‚å½“æ”¶å°¾ã€‚\n\n"
                        f"å¦‚æœè¯é¢˜å·²ç»èŠå¾—å·®ä¸å¤šäº†ï¼Œå¯ä»¥è‡ªç„¶åœ°è¡¨è¾¾æ”¶å°¾æ„æ„¿ï¼Œä¾‹å¦‚ï¼š\n"
                        f"- 'å—¯å—¯ï¼Œå·®ä¸å¤šå°±è¿™æ ·~'\n"
                        f"- 'å¥½çš„å¥½çš„'\n"
                        f"- 'è¡Œå§ï¼Œæœ‰ç©ºå†èŠ'\n\n"
                        f"âš ï¸ æ³¨æ„ï¼šè¿™åªæ˜¯å»ºè®®ï¼Œå¦‚æœè¯é¢˜è¿˜æœ‰å»¶ç»­æ€§ï¼Œå¯ä»¥ç»§ç»­æ­£å¸¸å›å¤ã€‚\n"
                        f"ç»å¯¹ç¦æ­¢æåŠ'ç–²åŠ³'ã€'è¿ç»­å¯¹è¯'ã€'ç³»ç»Ÿæç¤º'ç­‰å…ƒä¿¡æ¯ã€‚\n"
                        f"{separator}\n"
                    )

            # æ„å»ºå®Œæ•´çš„æç¤ºè¯ï¼Œæ ¹æ®prompt_modeå†³å®šæ‹¼æ¥è¿˜æ˜¯è¦†ç›–
            if prompt_mode == "override" and extra_prompt and extra_prompt.strip():
                # è¦†ç›–æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯ï¼ˆä»ç„¶æ·»åŠ å‘é€è€…å¼ºè°ƒå’Œç–²åŠ³æç¤ºï¼‰
                full_prompt = (
                    formatted_message + sender_emphasis + fatigue_closing_prompt + "\n\n" + extra_prompt.strip()
                )
                if DEBUG_MODE:
                    logger.info("ä½¿ç”¨è¦†ç›–æ¨¡å¼ï¼šç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯å®Œå…¨æ›¿ä»£é»˜è®¤ç³»ç»Ÿæç¤ºè¯")
            else:
                # æ‹¼æ¥æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼šå…ˆæ·»åŠ å‘é€è€…å¼ºè°ƒå’Œç–²åŠ³æç¤ºï¼Œå†æ·»åŠ ç³»ç»Ÿæç¤ºè¯
                full_prompt = (
                    formatted_message
                    + sender_emphasis
                    + fatigue_closing_prompt
                    + "\n\n"
                    + ReplyHandler.SYSTEM_REPLY_PROMPT
                )

                # å¦‚æœæœ‰ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯,æ’å…¥åˆ°ç»“æŸæŒ‡ä»¤ä¹‹å‰
                if extra_prompt and extra_prompt.strip():
                    full_prompt += f"\n\nç”¨æˆ·è¡¥å……è¯´æ˜:\n{extra_prompt.strip()}\n"
                    if DEBUG_MODE:
                        logger.info(
                            "ä½¿ç”¨æ‹¼æ¥æ¨¡å¼ï¼šåœ¨é»˜è®¤ç³»ç»Ÿæç¤ºè¯å’Œç»“æŸæŒ‡ä»¤ä¹‹é—´æ’å…¥ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯"
                        )

                # æ·»åŠ ç»“æŸæŒ‡ä»¤
                full_prompt += ReplyHandler.SYSTEM_REPLY_PROMPT_ENDING

            logger.info(
                f"æ­£åœ¨è°ƒç”¨AIç”Ÿæˆå›å¤ï¼ˆå½“å‰å‘é€è€…ï¼š{sender_name or 'æœªçŸ¥'}ï¼ŒID:{sender_id}ï¼‰..."
            )

            # è·å–å·¥å…·ç®¡ç†å™¨(å¦‚æœéœ€è¦)
            func_tools_mgr = context.get_llm_tool_manager()

            # ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨ persona_manager è·å–æœ€æ–°äººæ ¼é…ç½®ï¼Œæ”¯æŒå¤šä¼šè¯å’Œå®æ—¶æ›´æ–°
            system_prompt = ""
            begin_dialogs_text = ""
            try:
                # ç›´æ¥è°ƒç”¨ get_default_persona_v3() è·å–æœ€æ–°äººæ ¼é…ç½®
                # è¿™æ ·å¯ä»¥ç¡®ä¿ï¼š1. æ¯æ¬¡éƒ½è·å–æœ€æ–°é…ç½® 2. æ”¯æŒä¸åŒä¼šè¯ä½¿ç”¨ä¸åŒäººæ ¼
                default_persona = await context.persona_manager.get_default_persona_v3(
                    event.unified_msg_origin
                )

                system_prompt = default_persona.get("prompt", "")

                # è·å–begin_dialogså¹¶è½¬æ¢ä¸ºæ–‡æœ¬ï¼ˆè€Œä¸æ˜¯æ”¾åœ¨contextsä¸­ï¼‰
                begin_dialogs = default_persona.get("_begin_dialogs_processed", [])
                if begin_dialogs:
                    # å°†begin_dialogsè½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼ï¼Œå¹¶å…¥prompt
                    dialog_parts = []
                    for dialog in begin_dialogs:
                        role = dialog.get("role", "user")
                        content = dialog.get("content", "")
                        if role == "user":
                            dialog_parts.append(f"ç”¨æˆ·: {content}")
                        elif role == "assistant":
                            dialog_parts.append(f"AI: {content}")
                    if dialog_parts:
                        begin_dialogs_text = (
                            "\n=== é¢„è®¾å¯¹è¯ ===\n" + "\n".join(dialog_parts) + "\n\n"
                        )

                if DEBUG_MODE:
                    logger.info(
                        f"âœ… å·²è·å–å½“å‰äººæ ¼é…ç½®ï¼ˆpersona_managerï¼‰ï¼Œäººæ ¼å: {default_persona.get('name', 'default')}, é•¿åº¦: {len(system_prompt)} å­—ç¬¦"
                    )
                    if begin_dialogs_text:
                        logger.info(
                            f"å·²è·å–begin_dialogså¹¶è½¬æ¢ä¸ºæ–‡æœ¬ï¼Œé•¿åº¦: {len(begin_dialogs_text)} å­—ç¬¦"
                        )
            except Exception as e:
                logger.warning(f"è·å–äººæ ¼è®¾å®šå¤±è´¥: {e}ï¼Œä½¿ç”¨ç©ºäººæ ¼")

            # å¦‚æœæœ‰begin_dialogsï¼Œå°†å…¶æ·»åŠ åˆ°promptå¼€å¤´
            if begin_dialogs_text:
                full_prompt = begin_dialogs_text + full_prompt

            # ğŸ†• v1.2.0: æ”¹ç”¨ event.request_llm() æ›¿ä»£ provider.text_chat()
            # è¿™æ ·å¯ä»¥è®©å…¶ä»–æ’ä»¶ï¼ˆå¦‚ emotionaiï¼‰çš„ on_llm_request é’©å­ç”Ÿæ•ˆ
            # åŒæ—¶é€šè¿‡ event.set_extra() ä¼ é€’æ ‡è®°ï¼Œè®© main.py çš„é’©å­èƒ½è¯†åˆ«å¹¶å¤„ç†ä¸Šä¸‹æ–‡å†²çª
            if image_urls:
                if DEBUG_MODE:
                    logger.info(f"ğŸŸ¢ [å¤šæ¨¡æ€AI] ä¼ é€’ {len(image_urls)} å¼ å›¾ç‰‡ç»™LLM")
                    if logger.level <= 10:  # DEBUGçº§åˆ«
                        for i, url in enumerate(image_urls):
                            logger.info(f"  å›¾ç‰‡ {i}: {url}")

            # ğŸ†• v1.2.0: è®¾ç½®æ ‡è®°ï¼Œè®© main.py çš„ on_llm_request é’©å­èƒ½è¯†åˆ«è¿™æ˜¯æ¥è‡ªæœ¬æ’ä»¶çš„è¯·æ±‚
            event.set_extra(PLUGIN_REQUEST_MARKER, True)
            # å­˜å‚¨æ’ä»¶è‡ªå®šä¹‰çš„ä¸Šä¸‹æ–‡ï¼ˆç”¨äºæ›¿æ¢å¹³å° LTM æ³¨å…¥çš„ä¸Šä¸‹æ–‡ï¼‰
            event.set_extra(PLUGIN_CUSTOM_CONTEXTS, contexts)
            # å­˜å‚¨æ’ä»¶è‡ªå®šä¹‰çš„ç³»ç»Ÿæç¤ºè¯
            event.set_extra(PLUGIN_CUSTOM_SYSTEM_PROMPT, system_prompt)
            # å­˜å‚¨æ’ä»¶è‡ªå®šä¹‰çš„ prompt
            event.set_extra(PLUGIN_CUSTOM_PROMPT, full_prompt)
            # å­˜å‚¨å›¾ç‰‡ URL åˆ—è¡¨
            event.set_extra(PLUGIN_IMAGE_URLS, image_urls)

            if DEBUG_MODE:
                logger.info(f"ğŸ”§ [å…¼å®¹æ¨¡å¼] å·²è®¾ç½®æ’ä»¶æ ‡è®°ï¼Œå°†é€šè¿‡ event.request_llm() è°ƒç”¨ AI")
                logger.info(f"  - contexts æ•°é‡: {len(contexts)}")
                logger.info(f"  - system_prompt é•¿åº¦: {len(system_prompt)}")
                logger.info(f"  - full_prompt é•¿åº¦: {len(full_prompt)}")
                logger.info(f"  - image_urls æ•°é‡: {len(image_urls)}")

            # ğŸ†• v1.2.0: ä½¿ç”¨ event.request_llm() å‘èµ·è¯·æ±‚
            # è¿™ä¼šè§¦å‘å¹³å°çš„ on_llm_request é’©å­ï¼Œè®©å…¶ä»–æ’ä»¶èƒ½æ³¨å…¥æç¤ºè¯
            # main.py çš„ on_llm_request é’©å­ä¼šæ£€æµ‹æ ‡è®°å¹¶å¤„ç†ä¸Šä¸‹æ–‡å†²çª
            return event.request_llm(
                prompt=full_prompt,
                func_tool_manager=func_tools_mgr,
                session_id=event.session_id,
                image_urls=image_urls,
                contexts=contexts,
                system_prompt=system_prompt,
            )

        except Exception as e:
            logger.error(f"ç”ŸæˆAIå›å¤æ—¶å‘ç”Ÿé”™è¯¯: {e}")
            # è¿”å›é”™è¯¯æ¶ˆæ¯
            return event.plain_result(f"ç”Ÿæˆå›å¤æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}")

    @staticmethod
    def check_if_already_replied(event: AstrMessageEvent) -> bool:
        """
        æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²è¢«å…¶ä»–æ’ä»¶å¤„ç†

        ç”¨äº@æ¶ˆæ¯å…¼å®¹ï¼Œé¿å…é‡å¤å›å¤

        Args:
            event: æ¶ˆæ¯äº‹ä»¶

        Returns:
            True=å·²æœ‰å›å¤ï¼ŒFalse=å°šæœªå›å¤
        """
        try:
            # æ£€æŸ¥eventçš„resultå­—æ®µ
            # å¦‚æœå·²ç»æœ‰result,è¯´æ˜å·²ç»è¢«å¤„ç†äº†
            result = event.get_result()

            if result is None:
                return False

            # AstrBot ä¼šå°†å­—ç¬¦ä¸²ç»“æœè½¬æ¢ä¸º MessageEventResult
            if isinstance(result, MessageEventResult):
                has_stream = bool(getattr(result, "async_stream", None))
                has_chain = bool(getattr(result, "chain", []) or [])
                is_llm = bool(
                    getattr(result, "is_llm_result", None) and result.is_llm_result()
                )
                is_stopped = bool(
                    getattr(result, "result_type", None) == EventResultType.STOP
                )
                is_stream_state = bool(
                    getattr(result, "result_content_type", None)
                    in {
                        ResultContentType.STREAMING_RESULT,
                        ResultContentType.STREAMING_FINISH,
                    }
                )

                if has_stream or has_chain or is_llm or is_stopped or is_stream_state:
                    logger.info("æ£€æµ‹åˆ°è¯¥æ¶ˆæ¯å·²ç»è¢«å…¶ä»–æ’ä»¶å¤„ç†")
                    return True

                return False

            # æœªçŸ¥ç±»å‹çš„ç»“æœï¼Œä¿æŒå‘åå…¼å®¹ï¼šåªè¦éç©ºè§†ä¸ºå·²å¤„ç†
            if result:
                logger.info("æ£€æµ‹åˆ°è¯¥æ¶ˆæ¯å·²ç»è¢«å…¶ä»–æ’ä»¶å¤„ç†")
                return True

            return False

        except Exception as e:
            logger.error(f"æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å›å¤æ—¶å‘ç”Ÿé”™è¯¯: {e}")
            # å‘ç”Ÿé”™è¯¯æ—¶,ä¸ºå®‰å…¨èµ·è§,è¿”å›Trueé¿å…é‡å¤å›å¤
            return True
